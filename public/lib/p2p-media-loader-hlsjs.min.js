/**
 * @peertube/p2p-media-loader-hlsjs@1.0.14
 */
require=function e(t,n,i){function s(a,o){if(!n[a]){if(!t[a]){var d="function"==typeof require&&require;if(!o&&d)return d(a,!0);if(r)return r(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var l=n[a]={exports:{}};t[a][0].call(l.exports,(function(e){return s(t[a][1][e]||e)}),l,l.exports,e,t,n,i)}return n[a].exports}for(var r="function"==typeof require&&require,a=0;a<i.length;a++)s(i[a]);return s}({1:[function(e,t,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var s=Object.getOwnPropertyDescriptor(t,n);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,s)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return s(t,e),t};Object.defineProperty(n,"__esModule",{value:!0});const a=r(e("./index"));window.p2pml||(window.p2pml={}),window.p2pml.hlsjs=a},{"./index":"p2p-media-loader-hlsjs"}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.byteRangeToString=n.compareByteRanges=n.getByteRange=void 0,n.getByteRange=function(e){return e.rangeEnd&&void 0!==e.rangeStart?{offset:e.rangeStart,length:e.rangeEnd-e.rangeStart}:void 0},n.compareByteRanges=function(e,t){return void 0===e?void 0===t:void 0!==t&&e.length===t.length&&e.offset===t.offset},n.byteRangeToString=function(e){if(void 0===e)return;const t=e.offset+e.length-1;return`bytes=${e.offset}-${t}`}},{}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Engine=void 0;const i=e("events"),s=e("@peertube/p2p-media-loader-core"),r=e("./segment-manager"),a=e("./hlsjs-loader");class o extends i.EventEmitter{constructor(e={}){super(),this.currentLoaders=[],this.loader=new s.HybridLoader(e.loader),this.segmentManager=new r.SegmentManager(this.loader,e.segments),Object.keys(s.Events).map((e=>s.Events[e])).forEach((e=>this.loader.on(e,((...t)=>this.emit(e,...t)))))}static isSupported(){return s.HybridLoader.isSupported()}createLoaderClass(){var e;const t=this;return(e=class{constructor(){this.load=async(e,n,i)=>{!0!==e.url.endsWith(".m3u8")&&t.addLoaderImpl(this),this.context=e,this.callbacks=i,await this.impl.load(e,n,i)},this.abort=()=>{this.context&&this.impl.abort(this.context,this.callbacks)},this.destroy=()=>{this.context&&this.impl.abort(this.context),t.removeLoaderImpl(this)},this.getResponseHeader=()=>{},this.impl=new a.HlsJsLoader(t.segmentManager),this.stats=this.impl.stats}}).getEngine=()=>t,e}async destroy(){this.currentLoaders=[],await this.segmentManager.destroy()}abortCurrentRequest(){for(const e of this.currentLoaders)e.abort();this.currentLoaders=[]}getSettings(){return{segments:this.segmentManager.getSettings(),loader:this.loader.getSettings()}}getDetails(){return{loader:this.loader.getDetails()}}setPlayingSegment(e,t,n,i){this.segmentManager.setPlayingSegment(e,t,n,i)}setPlayingSegmentByCurrentTime(e){this.segmentManager.setPlayingSegmentByCurrentTime(e)}addLoaderImpl(e){this.currentLoaders.push(e)}removeLoaderImpl(e){this.currentLoaders=this.currentLoaders.filter((t=>t!==e))}}n.Engine=o},{"./hlsjs-loader":4,"./segment-manager":5,"@peertube/p2p-media-loader-core":14,events:"events"}],4:[function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.HlsJsLoader=void 0;const s=i(e("debug")),r=e("@peertube/p2p-media-loader-core"),a=e("./byte-range");class o{constructor(e){this.segmentManager=e,this.debug=(0,s.default)("p2pml:hlsjs-loader"),this.stats={loaded:0,total:0,aborted:!1,retry:0,chunkCount:0,bwEstimate:0,loading:{start:0,end:0,first:0},parsing:{start:0,end:0},buffering:{start:0,end:0,first:0}},this.boundOnSegmentAbort=this.onSegmentAbort.bind(this),this.boundOnUpdateSegmentSize=this.onUpdateSegmentSize.bind(this),this.boundOnUpdateLoaded=this.onUpdateLoaded.bind(this),this.boundOnSegmentStartLoad=this.onSegmentStartLoad.bind(this),this.debugId=""}async load(e,t,n){if(this.context=e,this.callbacks=n,o.updateStatsToStartLoading(this.stats),this.context.type){this.debug(`Loading playlist ${this.context.url}.`);try{const e=await this.segmentManager.loadPlaylist(this.context.url);this.debug(`Playlist ${this.context.url} loaded.`),this.successPlaylist(e,this.context,this.callbacks)}catch(e){this.error(e,this.context,this.callbacks)}}else if(this.context.frag){this.loader=this.segmentManager.loader,this.byteRange=(0,a.getByteRange)(this.context),this.debugId=this.byteRange?`${this.context.url} / ${this.byteRange.offset}`:this.context.url,this.debug(`Loading fragment ${this.debugId}.`),this.interval=setInterval((()=>o.updateStatsToStartLoading(this.stats)),200),this.loader.on(r.Events.SegmentAbort,this.boundOnSegmentAbort),this.loader.on(r.Events.SegmentSize,this.boundOnUpdateSegmentSize),this.loader.on(r.Events.SegmentStartLoad,this.boundOnSegmentStartLoad);try{const e=await this.segmentManager.loadSegment(this.context.url,this.byteRange),{content:t}=e;t?(this.successSegment(t,this.context,this.callbacks),this.debug(`Loaded fragment ${this.debugId}.`)):(this.cleanup(),this.debug(`Loaded empty fragment ${this.debugId} (aborted?).`))}catch(e){setTimeout((()=>this.error(e,this.context,this.callbacks)),0),this.debug(`Error in fragment ${this.debugId} loading.`,e)}}else console.warn("Unknown load request",this.context)}abort(e,t){if(this.stats.loaded||this.stats.aborted)return;this.debug(`Aborting by hls.js fragment ${this.debugId} loading.`),this.cleanup(),this.segmentManager.abortSegment(e.url,(0,a.getByteRange)(e)),this.stats.aborted=!0;const n=null==t?void 0:t.onAbort;n&&n(this.stats,e,void 0)}successPlaylist(e,t,n){this.cleanup();const i=performance.now();this.stats.loading.end=i,this.stats.loaded=e.response.length,this.stats.total=e.response.length,n.onSuccess({url:e.responseURL,data:e.response},this.stats,t,void 0)}successSegment(e,t,n){this.cleanup();const i=performance.now();this.stats.loading.end=i,this.stats.loaded=e.byteLength,this.stats.total=e.byteLength,n.onProgress&&n.onProgress(this.stats,t,e,void 0),n.onSuccess({url:t.url,data:e},this.stats,t,void 0)}error(e,t,n){this.cleanup(),n.onError(e,t,void 0)}cleanup(){this.interval&&(clearInterval(this.interval),this.interval=void 0),this.loader&&(this.loader.off(r.Events.SegmentStartLoad,this.boundOnSegmentStartLoad),this.loader.off(r.Events.SegmentSize,this.boundOnUpdateSegmentSize),this.loader.off(r.Events.PieceBytesDownloaded,this.boundOnUpdateLoaded),this.loader.off(r.Events.SegmentAbort,this.boundOnSegmentAbort))}onSegmentAbort(e){var t;if(!this.isSegment(e))return;this.debug(`Aborting by p2p-media-loader fragment ${this.debugId||""}.`),this.stats.aborted=!0;const n=null===(t=this.callbacks)||void 0===t?void 0:t.onAbort;n&&n(this.stats,this.context,void 0),this.cleanup()}onUpdateSegmentSize(e,t){this.isSegment(e)&&(this.stats.total=t)}onUpdateLoaded(e,t,n){this.isSegment(t)&&(this.stats.loaded+=n)}onSegmentStartLoad(e,t){this.interval&&"http"===e&&this.isSegment(t)&&(clearInterval(this.interval),this.interval=void 0,o.updateStatsToStartLoading(this.stats),this.loader.on(r.Events.PieceBytesDownloaded,this.boundOnUpdateLoaded))}isSegment(e){return e.url===this.context.url&&e.range===(0,a.byteRangeToString)(this.byteRange)}static updateStatsToStartLoading(e){if(e.aborted)return;const t=performance.now();e.loading.start=t,e.loading.first=t}}n.HlsJsLoader=o},{"./byte-range":2,"@peertube/p2p-media-loader-core":14,debug:"debug"}],5:[function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.SegmentManager=void 0;const s=i(e("debug")),r=e("@peertube/p2p-media-loader-core"),a=e("m3u8-parser"),o=e("./byte-range"),d={forwardSegmentCount:20,swarmId:void 0,assetsStorage:void 0};n.SegmentManager=class{constructor(e,t={}){this.debug=(0,s.default)("p2pml:segment-manager"),this.masterPlaylist=null,this.variantPlaylists=new Map,this.segmentRequest=null,this.playQueue=[],this.onSegmentLoaded=e=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&(0,o.byteRangeToString)(this.segmentRequest.segmentByteRange)===e.range&&(this.segmentRequest.onSuccess(e.data.slice(0),e.downloadBandwidth),this.segmentRequest=null)},this.onSegmentError=(e,t)=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&(0,o.byteRangeToString)(this.segmentRequest.segmentByteRange)===e.range&&(this.segmentRequest.onError(t),this.segmentRequest=null)},this.onSegmentAbort=e=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&(0,o.byteRangeToString)(this.segmentRequest.segmentByteRange)===e.range&&(this.segmentRequest.onError("Loading aborted: internal abort"),this.segmentRequest=null)},this.settings=Object.assign(Object.assign({},d),t),this.loader=e,this.loader.on(r.Events.SegmentLoaded,this.onSegmentLoaded),this.loader.on(r.Events.SegmentError,this.onSegmentError),this.loader.on(r.Events.SegmentAbort,this.onSegmentAbort)}getSettings(){return this.settings}processPlaylist(e,t,n){const i=new a.Parser;i.push(t),i.end();const s=new h(e,n,i.manifest);if(s.manifest.playlists){this.masterPlaylist=s;for(const[e,t]of this.variantPlaylists){const{streamSwarmId:n,found:i,index:s}=this.getStreamSwarmId(t.requestUrl);i?(t.streamSwarmId=n,t.streamId="V"+s.toString()):this.variantPlaylists.delete(e)}}else{const{streamSwarmId:t,found:n,index:i}=this.getStreamSwarmId(e);(n||null===this.masterPlaylist)&&(s.streamSwarmId=t,s.streamId=null===this.masterPlaylist?void 0:"V"+i.toString(),this.variantPlaylists.set(e,s),this.updateSegments())}}async loadPlaylist(e){const t=this.settings.assetsStorage;let n;if(void 0!==t){let i;i=this.getMasterSwarmId(),void 0===i&&(i=e.split("?")[0]);const s=await t.getAsset(e,void 0,i);void 0!==s?n={responseURL:s.responseUri,response:s.data}:(n=await this.loadContent(e,"text"),t.storeAsset({masterManifestUri:null!==this.masterPlaylist?this.masterPlaylist.requestUrl:e,masterSwarmId:i,requestUri:e,responseUri:n.responseURL,data:n.response}))}else n=await this.loadContent(e,"text");return this.processPlaylist(e,n.response,n.responseURL),n}async loadSegment(e,t){var n;const i=this.getSegmentLocation(e,t),s=(0,o.byteRangeToString)(t);if(!i){let t;const i=this.settings.assetsStorage;if(void 0!==i){let r,a=null===(n=this.masterPlaylist)||void 0===n?void 0:n.requestUrl;if(r=this.getMasterSwarmId(),void 0===r&&1===this.variantPlaylists.size){const e=this.variantPlaylists.values().next();e.done||(r=e.value.requestUrl.split("?")[0])}if(void 0===a&&1===this.variantPlaylists.size){const e=this.variantPlaylists.values().next();e.done||(a=e.value.requestUrl)}if(void 0!==r&&void 0!==a){const n=await i.getAsset(e,s,r);if(void 0!==n)t=n.data;else{const n=await this.loadContent(e,"arraybuffer",s);t=n.response,i.storeAsset({masterManifestUri:a,masterSwarmId:r,requestUri:e,requestRange:s,responseUri:n.responseURL,data:t})}}}if(void 0===t){t=(await this.loadContent(e,"arraybuffer",s)).response}return{content:t,downloadBandwidth:0}}const r=(i.playlist.manifest.mediaSequence?i.playlist.manifest.mediaSequence:0)+i.segmentIndex;if(this.playQueue.length>0){this.playQueue[this.playQueue.length-1].segmentSequence!==r-1&&(this.playQueue=[])}this.segmentRequest&&this.segmentRequest.onError("Cancel segment request: simultaneous segment requests are not supported");const a=new Promise(((n,s)=>{this.segmentRequest=new l(e,t,r,i.playlist.requestUrl,((e,t)=>n({content:e,downloadBandwidth:t})),(e=>s(e)))}));return this.playQueue.push({segmentUrl:e,segmentByteRange:t,segmentSequence:r}),this.loadSegments(i.playlist,i.segmentIndex,!0),a}setPlayingSegment(e,t,n,i){const s=this.playQueue.findIndex((n=>n.segmentUrl===e&&(0,o.compareByteRanges)(n.segmentByteRange,t)));this.debug("Set playing segment to index %d",s,this.playQueue),s>=0&&(this.playQueue=this.playQueue.slice(s),this.playQueue[0].playPosition={start:n,duration:i},this.updateSegments())}setPlayingSegmentByCurrentTime(e){if(0===this.playQueue.length||!this.playQueue[0].playPosition)return;const t=this.playQueue[0].playPosition;t.start+t.duration-e<.2&&(this.playQueue=this.playQueue.slice(1),this.updateSegments())}abortSegment(e,t){this.segmentRequest&&this.segmentRequest.segmentUrl===e&&(0,o.compareByteRanges)(this.segmentRequest.segmentByteRange,t)&&(this.segmentRequest.onSuccess(void 0,0),this.segmentRequest=null)}abortCurrentSegment(){this.segmentRequest&&(this.segmentRequest.onSuccess(void 0,0),this.segmentRequest=null)}async destroy(){this.segmentRequest&&(this.segmentRequest.onError("Loading aborted: object destroyed"),this.segmentRequest=null),this.masterPlaylist=null,this.variantPlaylists.clear(),this.playQueue=[],void 0!==this.settings.assetsStorage&&await this.settings.assetsStorage.destroy(),await this.loader.destroy()}updateSegments(){if(!this.segmentRequest)return;const e=this.getSegmentLocation(this.segmentRequest.segmentUrl,this.segmentRequest.segmentByteRange);this.debug("update segments",e),e&&this.loadSegments(e.playlist,e.segmentIndex,!1)}getSegmentLocation(e,t){for(const n of this.variantPlaylists.values()){const i=n.getSegmentIndex(e,t);if(i>=0)return{playlist:n,segmentIndex:i}}}async loadSegments(e,t,n){var i;const s=[],r=e.manifest.segments,a=null!==(i=e.manifest.mediaSequence)&&void 0!==i?i:0;let d=null,h=Math.max(0,this.playQueue.length-1);const l=this.getMasterSwarmId();this.debug("load segments",h,t);for(let i=t;i<r.length&&s.length<this.settings.forwardSegmentCount;++i){const t=e.manifest.segments[i],r=e.getSegmentAbsoluteUrl(t.uri),u=t.byterange,c=this.getSegmentId(e,a+i);s.push({id:c,url:r,masterSwarmId:void 0!==l?l:e.streamSwarmId,masterManifestUri:null!==this.masterPlaylist?this.masterPlaylist.requestUrl:e.requestUrl,streamId:e.streamId,sequence:(a+i).toString(),range:(0,o.byteRangeToString)(u),priority:h++}),n&&!d&&(d=c)}if(this.loader.load(s,e.streamSwarmId),d){const e=await this.loader.getSegment(d);e&&this.onSegmentLoaded(e)}}getSegmentId(e,t){return`${e.streamSwarmId}+${t}`}getMasterSwarmId(){const e=this.settings.swarmId&&0!==this.settings.swarmId.length?this.settings.swarmId:void 0;return void 0!==e?e:null!==this.masterPlaylist?this.masterPlaylist.requestUrl.split("?")[0]:void 0}getStreamSwarmId(e){const t=this.getMasterSwarmId();if(this.masterPlaylist&&this.masterPlaylist.manifest.playlists&&t)for(let n=0;n<this.masterPlaylist.manifest.playlists.length;++n){if(new URL(this.masterPlaylist.manifest.playlists[n].uri,this.masterPlaylist.responseUrl).toString()===e)return{streamSwarmId:`${t}+V${n}`,found:!0,index:n}}return{streamSwarmId:null!=t?t:e.split("?")[0],found:!1,index:-1}}async loadContent(e,t,n){return new Promise(((i,s)=>{const r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType=t,n&&r.setRequestHeader("Range",n),r.addEventListener("readystatechange",(()=>{4===r.readyState&&(r.status>=200&&r.status<300?i(r):s(r.statusText))}));const a=this.loader.getSettings().xhrSetup;a&&a(r,e),r.send()}))}};class h{constructor(e,t,n){this.requestUrl=e,this.responseUrl=t,this.manifest=n,this.streamSwarmId=""}getSegmentIndex(e,t){for(let n=0;n<this.manifest.segments.length;++n){const i=this.manifest.segments[n];if(e===this.getSegmentAbsoluteUrl(i.uri)&&(0,o.compareByteRanges)(i.byterange,t))return n}return-1}getSegmentAbsoluteUrl(e){return new URL(e,this.responseUrl).toString()}}class l{constructor(e,t,n,i,s,r){this.segmentUrl=e,this.segmentByteRange=t,this.segmentSequence=n,this.playlistRequestUrl=i,this.onSuccess=s,this.onError=r}}},{"./byte-range":2,"@peertube/p2p-media-loader-core":14,debug:"debug","m3u8-parser":32}],6:[function(e,t,n){t.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e},t.exports.__esModule=!0,t.exports.default=t.exports},{}],7:[function(e,t,n){function i(){return t.exports=i=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},t.exports.__esModule=!0,t.exports.default=t.exports,i.apply(this,arguments)}t.exports=i,t.exports.__esModule=!0,t.exports.default=t.exports},{}],8:[function(e,t,n){var i=e("./setPrototypeOf.js");t.exports=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,i(e,t)},t.exports.__esModule=!0,t.exports.default=t.exports},{"./setPrototypeOf.js":10}],9:[function(e,t,n){t.exports=function(e){return e&&e.__esModule?e:{default:e}},t.exports.__esModule=!0,t.exports.default=t.exports},{}],10:[function(e,t,n){function i(e,n){return t.exports=i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},t.exports.__esModule=!0,t.exports.default=t.exports,i(e,n)}t.exports=i,t.exports.__esModule=!0,t.exports.default=t.exports},{}],11:[function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.BandwidthApproximator=void 0;const s=(0,i(e("debug")).default)("p2pml:bandwidth-approximator"),r=2e3;class a{constructor(e,t){this.value=e,this.timeStamp=t}}n.BandwidthApproximator=class{constructor(){this.lastBytes=[],this.currentBytesSum=0,this.lastBandwidth=[],this.addBytes=(e,t)=>{for(s("Add %d bytes.",e),this.lastBytes.push(new a(e,t)),this.currentBytesSum+=e;t-this.lastBytes[0].timeStamp>r;)this.currentBytesSum-=this.lastBytes.shift().value;const n=Math.min(r,t);this.lastBandwidth.push(new a(this.currentBytesSum/n,t))},this.getBandwidth=e=>{for(;0!==this.lastBandwidth.length&&e-this.lastBandwidth[0].timeStamp>4e4;)this.lastBandwidth.shift();let t=0;for(const e of this.lastBandwidth)e.value>t&&(t=e.value);return s("Max bandwidth: %d.",t),t},this.getSmoothInterval=()=>r,this.getMeasureInterval=()=>4e4}}},{debug:"debug"}],12:[function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.HttpMediaManager=void 0;const s=i(e("debug")),r=e("./stringly-typed-event-emitter");class a extends r.STEEmitter{}n.HttpMediaManager=class extends a{constructor(e){super(),this.settings=e,this.xhrRequests=new Map,this.failedSegments=new Map,this.debug=(0,s.default)("p2pml:http-media-manager"),this.download=(e,t)=>{if(this.isDownloading(e))return;this.cleanTimedOutFailedSegments(),this.emit("segment-start-load",e);const n=e.priority<=this.settings.skipSegmentBuilderPriority?e.url:this.buildSegmentUrl(e);this.debug("http segment download",n),e.requestUrl=n;const i=new XMLHttpRequest;if(i.open("GET",n,!0),i.responseType="arraybuffer",e.range)i.setRequestHeader("Range",e.range),t=void 0;else if(void 0!==t&&this.settings.httpUseRanges){let e=0;for(const n of t)e+=n.byteLength;i.setRequestHeader("Range",`bytes=${e}-`),this.debug("continue download from",e)}else t=void 0;this.setupXhrEvents(i,e,t),this.settings.xhrSetup&&this.settings.xhrSetup(i,n),this.xhrRequests.set(e.id,{xhr:i,segment:e,initialPriority:e.priority,segmentUrl:n}),i.send()},this.updatePriority=e=>{const t=this.xhrRequests.get(e.id);if(!t)throw new Error("Cannot update priority of not downloaded segment "+e.id);e.priority<=this.settings.skipSegmentBuilderPriority&&t.initialPriority>this.settings.skipSegmentBuilderPriority&&t.segmentUrl!==e.url&&(this.debug("aborting http segment because the segment is now in a high priority",e.id),this.abort(e),this.download(e))},this.abort=e=>{const t=this.xhrRequests.get(e.id);t&&(t.xhr.abort(),this.xhrRequests.delete(e.id),this.debug("http segment abort",e.id))},this.isDownloading=e=>this.xhrRequests.has(e.id),this.isFailed=e=>{const t=this.failedSegments.get(e.id);return void 0!==t&&t>this.now()},this.getActiveDownloads=()=>this.xhrRequests,this.getActiveDownloadsCount=()=>this.xhrRequests.size,this.destroy=()=>{this.xhrRequests.forEach((e=>e.xhr.abort())),this.xhrRequests.clear()},this.setupXhrEvents=(e,t,n)=>{let i=0;e.addEventListener("progress",(e=>{const n=e.loaded-i;this.emit("bytes-downloaded",t,n),i=e.loaded,e.lengthComputable&&this.emit("segment-size",t,e.total)})),e.addEventListener("load",(async i=>{if(e.status<200||e.status>=300)return void this.segmentFailure(t,i,e);let s=e.response;if(void 0!==n&&206===e.status){let e=0;for(const t of n)e+=t.byteLength;const t=new Uint8Array(e+s.byteLength);let i=0;for(const e of n)t.set(new Uint8Array(e),i),i+=e.byteLength;t.set(new Uint8Array(s),i),s=t.buffer}await this.segmentDownloadFinished(t,s,e)})),e.addEventListener("error",(n=>{this.segmentFailure(t,n,e)})),e.addEventListener("timeout",(n=>{this.segmentFailure(t,n,e)}))},this.segmentDownloadFinished=async(e,t,n)=>{if(e.responseUrl=null===n.responseURL?void 0:n.responseURL,this.settings.segmentValidator)try{await this.settings.segmentValidator(Object.assign(Object.assign({},e),{data:t}),"http")}catch(t){return this.debug("segment validator failed",t),void this.segmentFailure(e,t,n)}this.xhrRequests.delete(e.id),this.emit("segment-loaded",e,t)},this.segmentFailure=(e,t,n)=>{e.responseUrl=null===n.responseURL?void 0:n.responseURL,this.xhrRequests.delete(e.id),this.failedSegments.set(e.id,this.now()+this.settings.httpFailedSegmentTimeout),this.emit("segment-error",e,t)},this.cleanTimedOutFailedSegments=()=>{const e=this.now(),t=[];this.failedSegments.forEach(((n,i)=>{n<e&&t.push(i)})),t.forEach((e=>this.failedSegments.delete(e)))},this.now=()=>performance.now()}buildSegmentUrl(e){return this.settings.segmentUrlBuilder?this.settings.segmentUrlBuilder(e):e.url}}},{"./stringly-typed-event-emitter":19,debug:"debug"}],13:[function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.HybridLoader=void 0;const s=i(e("debug")),r=e("events"),a=i(e("simple-peer")),o=e("./loader-interface"),d=e("./http-media-manager"),h=e("./p2p-media-manager"),l=e("./media-peer"),u=e("./bandwidth-approximator"),c=e("./segments-memory-storage"),g={cachedSegmentExpiration:3e5,cachedSegmentsCount:30,useP2P:!0,consumeOnly:!1,requiredSegmentsPriority:1,skipSegmentBuilderPriority:1,simultaneousHttpDownloads:2,httpDownloadProbability:.1,httpDownloadProbabilityInterval:1e3,httpDownloadProbabilitySkipIfNoPeers:!1,httpFailedSegmentTimeout:1e4,httpDownloadMaxPriority:20,httpDownloadInitialTimeout:0,httpDownloadInitialTimeoutPerSegment:4e3,httpUseRanges:!1,simultaneousP2PDownloads:3,p2pDownloadMaxPriority:20,p2pSegmentDownloadTimeout:6e4,webRtcMaxMessageSize:65535,trackerAnnounce:["wss://tracker.novage.com.ua","wss://tracker.openwebtorrent.com"],peerRequestsPerAnnounce:10,rtcConfig:a.default.config};class f extends r.EventEmitter{constructor(e={}){super(),this.debug=(0,s.default)("p2pml:hybrid-loader"),this.debugSegments=(0,s.default)("p2pml:hybrid-loader-segments"),this.segmentsQueue=[],this.bandwidthApproximator=new u.BandwidthApproximator,this.httpDownloadInitialTimeoutTimestamp=-1/0,this.createHttpManager=()=>new d.HttpMediaManager(this.settings),this.createP2PManager=()=>new h.P2PMediaManager(this.segmentsStorage,this.settings),this.load=async(e,t)=>{this.initRandomDownloadIntervalIfNeeded(),e.length>0&&(this.masterSwarmId=e[0].masterSwarmId),void 0!==this.masterSwarmId&&this.p2pManager.setStreamSwarmId(t,this.masterSwarmId),this.debug("load segments");let n=this.abortUnknownSegments(e);if(this.debug.enabled)for(const t of e)this.segmentsQueue.find((e=>e.id===t.id))||this.debug("add segment",t.id);if(this.segmentsQueue=e,void 0===this.masterSwarmId)return;let i=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);n=this.processSegmentsQueue(i)||n,await this.cleanSegmentsStorage()&&(i=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId),n=!0),n&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(i))},this.getSegment=async e=>void 0===this.masterSwarmId?void 0:this.segmentsStorage.getSegment(e,this.masterSwarmId),this.getSettings=()=>this.settings,this.getDetails=()=>({peerId:this.p2pManager.getPeerId()}),this.getBandwidthEstimate=()=>this.bandwidthApproximator.getBandwidth(this.now()),this.destroy=async()=>{void 0!==this.httpRandomDownloadInterval&&(clearInterval(this.httpRandomDownloadInterval),this.httpRandomDownloadInterval=void 0),this.httpDownloadInitialTimeoutTimestamp=-1/0,this.segmentsQueue=[],this.httpManager.destroy(),this.p2pManager.destroy(),this.masterSwarmId=void 0,await this.segmentsStorage.destroy()},this.processInitialSegmentTimeout=async()=>{if(void 0!==this.httpRandomDownloadInterval){if(void 0!==this.masterSwarmId){const e=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))}this.httpDownloadInitialTimeoutTimestamp!==-1/0&&setTimeout(this.processInitialSegmentTimeout,this.settings.httpDownloadInitialTimeoutPerSegment)}},this.processSegmentsQueue=e=>{const t=this.segmentsQueue.length>0?this.segmentsQueue[0].priority:0;if(this.debugSegments(`process segments queue. priority: ${t}, queue length: ${this.segmentsQueue.length}`),void 0===this.masterSwarmId||0===this.segmentsQueue.length)return!1;let n,i=!1,s=!0;if(this.httpDownloadInitialTimeoutTimestamp!==-1/0){let t;for(const n of this.segmentsQueue)if(!e.has(n.id)){t=n.priority;break}const n=this.now()-this.httpDownloadInitialTimeoutTimestamp;s=n>=this.settings.httpDownloadInitialTimeout||void 0!==t&&n>this.settings.httpDownloadInitialTimeoutPerSegment&&t<=0,s&&(this.debugSegments("cancel initial HTTP download timeout - timed out"),this.httpDownloadInitialTimeoutTimestamp=-1/0)}let r=!1;for(let t=0;t<this.segmentsQueue.length;t++){const a=this.segmentsQueue[t];if(e.has(a.id))continue;if(this.httpManager.isDownloading(a)){this.httpManager.updatePriority(a);continue}const o=s&&a.priority<=this.settings.requiredSegmentsPriority;if(o&&!this.httpManager.isFailed(a)){if(this.httpManager.getActiveDownloadsCount()>=this.settings.simultaneousHttpDownloads)for(let e=this.segmentsQueue.length-1;e>t;e--){const t=this.segmentsQueue[e];if(this.httpManager.isDownloading(t)){this.debugSegments("cancel HTTP download",t.priority,t.id),this.httpManager.abort(t);break}}if(this.httpManager.getActiveDownloadsCount()<this.settings.simultaneousHttpDownloads){const e=this.p2pManager.abort(a);this.httpManager.download(a,e),this.debugSegments("HTTP download (priority)",a.priority,a.id),i=!0;continue}}if(o&&this.httpManager.isFailed(a)&&(r=!0),!this.p2pManager.isDownloading(a))if(a.priority<=this.settings.requiredSegmentsPriority){if(n=n||this.p2pManager.getOverallSegmentsMap(),n.get(a.id)!==l.MediaPeerSegmentStatus.Loaded)continue;if(this.p2pManager.getActiveDownloadsCount()>=this.settings.simultaneousP2PDownloads)for(let e=this.segmentsQueue.length-1;e>t;e--){const t=this.segmentsQueue[e];if(this.p2pManager.isDownloading(t)){this.debugSegments("cancel P2P download",t.priority,t.id),this.p2pManager.abort(t);break}}if(this.p2pManager.getActiveDownloadsCount()<this.settings.simultaneousP2PDownloads&&this.p2pManager.download(a)){this.debugSegments("P2P download (priority)",a.priority,a.id);continue}}else this.p2pManager.getActiveDownloadsCount()<this.settings.simultaneousP2PDownloads&&a.priority<=this.settings.p2pDownloadMaxPriority&&this.p2pManager.download(a)&&this.debugSegments("P2P download",a.priority,a.id)}return r&&setTimeout((async()=>{if(void 0===this.masterSwarmId)return;const e=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)}),this.settings.httpFailedSegmentTimeout),i},this.downloadRandomSegmentOverHttp=async()=>{if(void 0===this.masterSwarmId||void 0===this.httpRandomDownloadInterval||this.httpDownloadInitialTimeoutTimestamp!==-1/0||this.httpManager.getActiveDownloadsCount()>=this.settings.simultaneousHttpDownloads||this.settings.httpDownloadProbabilitySkipIfNoPeers&&0===this.p2pManager.getPeers().size||this.settings.consumeOnly)return;const e=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId),t=this.p2pManager.getOverallSegmentsMap(),n=this.segmentsQueue.filter((n=>!this.p2pManager.isDownloading(n)&&!this.httpManager.isDownloading(n)&&!t.has(n.id)&&!this.httpManager.isFailed(n)&&n.priority<=this.settings.httpDownloadMaxPriority&&!e.has(n.id)));if(0===n.length)return;if(Math.random()>this.settings.httpDownloadProbability*n.length)return;const i=n[Math.floor(Math.random()*n.length)];this.debugSegments("HTTP download (random)",i.priority,i.id),this.httpManager.download(i),this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))},this.onSegmentStartLoad=(e,t)=>{this.emit(o.Events.SegmentStartLoad,e,t)},this.onPieceBytesDownloaded=(e,t,n,i)=>{this.bandwidthApproximator.addBytes(n,this.now()),this.emit(o.Events.PieceBytesDownloaded,e,t,n,i)},this.onPieceBytesUploaded=(e,t,n,i)=>{this.emit(o.Events.PieceBytesUploaded,e,t,n,i)},this.onSegmentLoaded=async(e,t,n)=>{if(this.debugSegments("segment loaded",e.id,e.id),void 0===this.masterSwarmId)return;e.data=t,e.downloadBandwidth=this.bandwidthApproximator.getBandwidth(this.now()),await this.segmentsStorage.storeSegment(e),this.emit(o.Events.SegmentLoaded,e,n);const i=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(i),this.settings.consumeOnly||this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(i))},this.onSegmentError=async(e,t,n)=>{if(this.debugSegments("segment error",e.id,e.id,n,t),this.emit(o.Events.SegmentError,e,t,n),void 0!==this.masterSwarmId){const e=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))}},this.onSegmentSize=async(e,t)=>{this.debugSegments("segment size",e.id,t),this.emit(o.Events.SegmentSize,e,t)},this.getStreamSwarmId=e=>void 0===e.streamId?e.masterSwarmId:`${e.masterSwarmId}+${e.streamId}`,this.createSegmentsMap=e=>{const t={},n=(e,n)=>{const i=this.getStreamSwarmId(e),s=e.sequence;let r=t[i];void 0===r&&(r=["",[]],t[i]=r);const a=r[1];r[0]+=0===a.length?s:`|${s}`,a.push(n)};for(const t of e.values())n(t.segment,l.MediaPeerSegmentStatus.Loaded);for(const e of this.httpManager.getActiveDownloads().values())n(e.segment,l.MediaPeerSegmentStatus.LoadingByHttp);return t},this.onPeerConnect=async e=>{this.emit(o.Events.PeerConnect,e),this.settings.consumeOnly||void 0===this.masterSwarmId||this.p2pManager.sendSegmentsMap(e.id,this.createSegmentsMap(await this.segmentsStorage.getSegmentsMap(this.masterSwarmId)))},this.onPeerClose=e=>{this.emit(o.Events.PeerClose,e)},this.onTrackerUpdate=async e=>{if(this.httpDownloadInitialTimeoutTimestamp!==-1/0&&void 0!==e.incomplete&&e.incomplete<=1&&(this.debugSegments("cancel initial HTTP download timeout - no peers"),this.httpDownloadInitialTimeoutTimestamp=-1/0,void 0!==this.masterSwarmId)){const e=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))}},this.cleanSegmentsStorage=async()=>void 0!==this.masterSwarmId&&this.segmentsStorage.clean(this.masterSwarmId,(e=>void 0!==this.segmentsQueue.find((t=>t.id===e)))),this.now=()=>performance.now(),this.initRandomDownloadIntervalIfNeeded=()=>{void 0===this.httpRandomDownloadInterval&&(this.httpRandomDownloadInterval=setInterval(this.downloadRandomSegmentOverHttp,this.settings.httpDownloadProbabilityInterval),this.settings.httpDownloadInitialTimeout>0&&this.settings.httpDownloadInitialTimeoutPerSegment>0&&(this.debugSegments("enable initial HTTP download timeout",this.settings.httpDownloadInitialTimeout,"per segment",this.settings.httpDownloadInitialTimeoutPerSegment),this.httpDownloadInitialTimeoutTimestamp=this.now(),setTimeout(this.processInitialSegmentTimeout,this.settings.httpDownloadInitialTimeoutPerSegment+100)))},this.abortUnknownSegments=e=>{let t=!1;for(const n of this.segmentsQueue)e.find((e=>e.id===n.id))||(this.debug("remove segment",n.id),this.httpManager.isDownloading(n)?(t=!0,this.httpManager.abort(n)):this.p2pManager.abort(n),this.emit(o.Events.SegmentAbort,n));return t},this.settings=Object.assign(Object.assign({},g),e);const{bufferedSegmentsCount:t}=e;"number"==typeof t&&(void 0===e.p2pDownloadMaxPriority&&(this.settings.p2pDownloadMaxPriority=t),void 0===e.httpDownloadMaxPriority&&(this.settings.p2pDownloadMaxPriority=t)),this.segmentsStorage=void 0===this.settings.segmentsStorage?new c.SegmentsMemoryStorage(this.settings):this.settings.segmentsStorage,this.debug("loader settings",this.settings),this.httpManager=this.createHttpManager(),this.httpManager.on("segment-start-load",(e=>this.onSegmentStartLoad("http",e))),this.httpManager.on("segment-loaded",this.onSegmentLoaded),this.httpManager.on("segment-error",this.onSegmentError),this.httpManager.on("segment-size",this.onSegmentSize),this.httpManager.on("bytes-downloaded",((e,t)=>{this.onPieceBytesDownloaded("http",e,t)})),this.p2pManager=this.createP2PManager(),this.p2pManager.on("segment-start-load",(e=>this.onSegmentStartLoad("p2p",e))),this.p2pManager.on("segment-loaded",this.onSegmentLoaded),this.p2pManager.on("segment-error",this.onSegmentError),this.p2pManager.on("segment-size",this.onSegmentSize),this.p2pManager.on("peer-data-updated",(async()=>{if(void 0===this.masterSwarmId)return;const e=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))})),this.p2pManager.on("bytes-downloaded",((e,t,n)=>this.onPieceBytesDownloaded("p2p",e,t,n))),this.p2pManager.on("bytes-uploaded",((e,t,n)=>this.onPieceBytesUploaded("p2p",e,t,n))),this.p2pManager.on("peer-connected",this.onPeerConnect),this.p2pManager.on("peer-closed",this.onPeerClose),this.p2pManager.on("tracker-update",this.onTrackerUpdate)}}n.HybridLoader=f,f.isSupported=()=>void 0!==window.RTCPeerConnection.prototype.createDataChannel},{"./bandwidth-approximator":11,"./http-media-manager":12,"./loader-interface":15,"./media-peer":16,"./p2p-media-manager":17,"./segments-memory-storage":18,debug:"debug",events:"events","simple-peer":41}],14:[function(e,t,n){"use strict";
/**
 * @license Apache-2.0
 * Copyright 2018 Novage LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var s=Object.getOwnPropertyDescriptor(t,n);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,s)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),s=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||i(t,e,n)};Object.defineProperty(n,"__esModule",{value:!0}),n.version=void 0,n.version="0.6.2",s(e("./loader-interface"),n),s(e("./hybrid-loader"),n)},{"./hybrid-loader":13,"./loader-interface":15}],15:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Events=void 0,function(e){e.SegmentLoaded="segment_loaded",e.SegmentError="segment_error",e.SegmentSize="segment_size",e.SegmentAbort="segment_abort",e.SegmentStartLoad="segment_start_load",e.PeerConnect="peer_connect",e.PeerClose="peer_close",e.PieceBytesDownloaded="piece_bytes_downloaded",e.PieceBytesUploaded="piece_bytes_uploaded"}(n.Events||(n.Events={}))},{}],16:[function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.MediaPeer=n.MediaPeerSegmentStatus=void 0;const s=i(e("debug")),r=e("buffer"),a=e("./stringly-typed-event-emitter");var o,d;!function(e){e[e.SegmentData=0]="SegmentData",e[e.SegmentAbsent=1]="SegmentAbsent",e[e.SegmentsMap=2]="SegmentsMap",e[e.SegmentRequest=3]="SegmentRequest",e[e.CancelSegmentRequest=4]="CancelSegmentRequest"}(o||(o={})),function(e){e[e.Loaded=0]="Loaded",e[e.LoadingByHttp=1]="LoadingByHttp"}(d=n.MediaPeerSegmentStatus||(n.MediaPeerSegmentStatus={}));class h{constructor(e,t){this.id=e,this.size=t,this.bytesDownloaded=0,this.pieces=[]}}class l extends a.STEEmitter{constructor(e,t){super(),this.peer=e,this.settings=t,this.remoteAddress="",this.downloadingSegmentId=null,this.downloadingSegment=null,this.segmentsMap=new Map,this.debug=(0,s.default)("p2pml:media-peer"),this.timer=null,this.onPeerConnect=()=>{this.debug("peer connect",this.id,this),this.remoteAddress=this.peer.remoteAddress,this.emit("connect",this)},this.onPeerClose=()=>{this.debug("peer close",this.id,this),this.terminateSegmentRequest(),this.emit("close",this)},this.onPeerError=e=>{this.debug("peer error",this.id,e,this)},this.receiveSegmentPiece=e=>{if(!this.downloadingSegment)return void this.debug("peer segment not requested",this.id,this);this.downloadingSegment.bytesDownloaded+=e.byteLength,this.downloadingSegment.pieces.push(e);const t=this.downloadingSegment.id;if(this.emit("bytes-downloaded",this,t,e.byteLength),this.downloadingSegment.bytesDownloaded===this.downloadingSegment.size){const e=new Uint8Array(this.downloadingSegment.size);let n=0;for(const t of this.downloadingSegment.pieces)e.set(new Uint8Array(t),n),n+=t.byteLength;this.debug("peer segment download done",this.id,t,this),this.terminateSegmentRequest(),this.emit("segment-loaded",this,t,e.buffer)}else this.downloadingSegment.bytesDownloaded>this.downloadingSegment.size&&(this.debug("peer segment download bytes mismatch",this.id,t,this),this.terminateSegmentRequest(),this.emit("segment-error",this,t,"Too many bytes received for segment"))},this.getJsonCommand=e=>{const t=new Uint8Array(e);if(123===t[0]&&34===t[1]&&125===t[e.byteLength-1])try{return JSON.parse((new TextDecoder).decode(e))}catch(e){return null}return null},this.onPeerData=e=>{const t=this.getJsonCommand(e);if(null!==t){if(this.downloadingSegment){this.debug("peer segment download is interrupted by a command",this.id,this);const e=this.downloadingSegment.id;return this.terminateSegmentRequest(),void this.emit("segment-error",this,e,"Segment download is interrupted by a command")}switch(this.debug("peer receive command",this.id,t,this),t.c){case o.SegmentsMap:this.segmentsMap=this.createSegmentsMap(t.m),this.emit("data-updated");break;case o.SegmentRequest:this.emit("segment-request",this,t.i);break;case o.SegmentData:this.downloadingSegmentId&&this.downloadingSegmentId===t.i&&"number"==typeof t.s&&t.s>=0&&(this.downloadingSegment=new h(t.i,t.s),this.emit("segment-start-load",this.downloadingSegment.id),this.emit("segment-size",this.downloadingSegment.id,this.downloadingSegment.size),this.cancelResponseTimeoutTimer());break;case o.SegmentAbsent:this.downloadingSegmentId&&this.downloadingSegmentId===t.i&&(this.terminateSegmentRequest(),this.segmentsMap.delete(t.i),this.emit("segment-absent",this,t.i));case o.CancelSegmentRequest:}}else this.receiveSegmentPiece(e)},this.createSegmentsMap=e=>{if(!(e instanceof Object))return new Map;const t=new Map;for(const n of Object.keys(e)){const i=e[n];if(!(i instanceof Array&&2===i.length&&"string"==typeof i[0]&&i[1]instanceof Array))return new Map;const s=i[0].split("|"),r=i[1];if(s.length!==r.length)return new Map;for(let e=0;e<s.length;e++){const i=r[e];if("number"!=typeof i||void 0===d[i])return new Map;t.set(`${n}+${s[e]}`,i)}}return t},this.sendCommand=e=>{this.debug("peer send command",this.id,e,this),this.peer.write(JSON.stringify(e))},this.destroy=()=>{this.debug("peer destroy",this.id,this),this.terminateSegmentRequest(),this.peer.destroy()},this.getDownloadingSegmentId=()=>this.downloadingSegmentId,this.getSegmentsMap=()=>this.segmentsMap,this.sendSegmentsMap=e=>{this.sendCommand({c:o.SegmentsMap,m:e})},this.sendSegmentData=(e,t)=>{this.sendCommand({c:o.SegmentData,i:e,s:t.byteLength});let n=t.byteLength;for(;n>0;){const e=n>=this.settings.webRtcMaxMessageSize?this.settings.webRtcMaxMessageSize:n,i=r.Buffer.from(t,t.byteLength-n,e);this.peer.write(i),n-=e}this.emit("bytes-uploaded",this,e,t.byteLength)},this.sendSegmentAbsent=e=>{this.sendCommand({c:o.SegmentAbsent,i:e})},this.requestSegment=e=>{if(this.downloadingSegmentId)throw new Error("A segment is already downloading: "+this.downloadingSegmentId);this.sendCommand({c:o.SegmentRequest,i:e}),this.downloadingSegmentId=e,this.runResponseTimeoutTimer()},this.cancelSegmentRequest=()=>{let e;if(this.downloadingSegmentId){const t=this.downloadingSegmentId;e=this.downloadingSegment?this.downloadingSegment.pieces:void 0,this.terminateSegmentRequest(),this.sendCommand({c:o.CancelSegmentRequest,i:t})}return e},this.runResponseTimeoutTimer=()=>{this.timer=setTimeout((()=>{if(this.timer=null,!this.downloadingSegmentId)return;const e=this.downloadingSegmentId;this.cancelSegmentRequest(),this.emit("segment-timeout",this,e)}),this.settings.p2pSegmentDownloadTimeout)},this.cancelResponseTimeoutTimer=()=>{this.timer&&(clearTimeout(this.timer),this.timer=null)},this.terminateSegmentRequest=()=>{this.downloadingSegmentId=null,this.downloadingSegment=null,this.cancelResponseTimeoutTimer()},this.peer.on("connect",this.onPeerConnect),this.peer.on("close",this.onPeerClose),this.peer.on("error",this.onPeerError),this.peer.on("data",this.onPeerData),this.id=e.id}}n.MediaPeer=l},{"./stringly-typed-event-emitter":19,buffer:"buffer",debug:"debug"}],17:[function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.P2PMediaManager=void 0;const s=i(e("debug")),r=i(e("bittorrent-tracker/client")),a=e("buffer"),o=i(e("sha.js/sha1")),d=e("./stringly-typed-event-emitter"),h=e("./media-peer"),l=e("./index"),u=`-WW${l.version.replace(/\d*./g,(e=>("0"+parseInt(e,10)%100).slice(-2))).slice(0,4)}-`;class c{constructor(e,t){this.peerId=e,this.segment=t}}class g extends d.STEEmitter{constructor(e,t){super(),this.segmentsStorage=e,this.settings=t,this.trackerClient=null,this.peers=new Map,this.peerCandidates=new Map,this.peerSegmentRequests=new Map,this.streamSwarmId=null,this.debug=(0,s.default)("p2pml:p2p-media-manager"),this.pendingTrackerClient=null,this.getPeers=()=>this.peers,this.getPeerId=()=>a.Buffer.from(this.peerId).toString("hex"),this.setStreamSwarmId=(e,t)=>{if(this.streamSwarmId===e)return;this.destroy(!0),this.streamSwarmId=e,this.masterSwarmId=t,this.debug("stream swarm ID",this.streamSwarmId),this.pendingTrackerClient={isDestroyed:!1};const n=this.pendingTrackerClient,i=(new o.default).update(`2${this.streamSwarmId}`).digest();n.isDestroyed?null!==this.trackerClient&&(this.trackerClient.destroy(),this.trackerClient=null):(this.pendingTrackerClient=null,this.createClient(i))},this.createClient=e=>{if(!this.settings.useP2P)return;const t={infoHash:a.Buffer.from(e,0,20),peerId:a.Buffer.from(this.peerId,0,20),announce:this.settings.trackerAnnounce,rtcConfig:this.settings.rtcConfig,port:6881,getAnnounceOpts:()=>({numwant:this.settings.peerRequestsPerAnnounce})};let n=this.trackerClient;this.trackerClient=new r.default(t),this.trackerClient.on("error",this.onTrackerError),this.trackerClient.on("warning",this.onTrackerWarning),this.trackerClient.on("update",this.onTrackerUpdate),this.trackerClient.on("peer",this.onTrackerPeer),this.trackerClient.start(),null!==n&&(n.destroy(),n=null)},this.onTrackerError=e=>{this.debug("tracker error",e)},this.onTrackerWarning=e=>{this.debug("tracker warning",e)},this.onTrackerUpdate=e=>{this.debug("tracker update",e),this.emit("tracker-update",e)},this.onTrackerPeer=e=>{if(this.debug("tracker peer",e.id,e),this.peers.has(e.id))return this.debug("tracker peer already connected",e.id,e),void e.destroy();const t=new h.MediaPeer(e,this.settings);t.on("connect",this.onPeerConnect),t.on("close",this.onPeerClose),t.on("data-updated",this.onPeerDataUpdated),t.on("segment-request",this.onSegmentRequest),t.on("segment-loaded",this.onSegmentLoaded),t.on("segment-absent",this.onSegmentAbsent),t.on("segment-error",this.onSegmentError),t.on("segment-size",this.onSegmentSize),t.on("segment-start-load",this.onSegmentStartLoad),t.on("segment-timeout",this.onSegmentTimeout),t.on("bytes-downloaded",this.onPieceBytesDownloaded),t.on("bytes-uploaded",this.onPieceBytesUploaded);let n=this.peerCandidates.get(t.id);n||(n=[],this.peerCandidates.set(t.id,n)),n.push(t)},this.download=e=>{if(this.isDownloading(e))return!1;const t=[];for(const n of this.peers.values())null===n.getDownloadingSegmentId()&&n.getSegmentsMap().get(e.id)===h.MediaPeerSegmentStatus.Loaded&&t.push(n);if(0===t.length)return!1;const n=t[Math.floor(Math.random()*t.length)];return n.requestSegment(e.id),this.peerSegmentRequests.set(e.id,new c(n.id,e)),!0},this.abort=e=>{let t;const n=this.peerSegmentRequests.get(e.id);if(n){const i=this.peers.get(n.peerId);i&&(t=i.cancelSegmentRequest()),this.peerSegmentRequests.delete(e.id)}return t},this.isDownloading=e=>this.peerSegmentRequests.has(e.id),this.getActiveDownloadsCount=()=>this.peerSegmentRequests.size,this.destroy=(e=!1)=>{this.streamSwarmId=null,this.trackerClient&&(this.trackerClient.stop(),e?(this.trackerClient.removeAllListeners("error"),this.trackerClient.removeAllListeners("warning"),this.trackerClient.removeAllListeners("update"),this.trackerClient.removeAllListeners("peer")):(this.trackerClient.destroy(),this.trackerClient=null)),this.pendingTrackerClient&&(this.pendingTrackerClient.isDestroyed=!0,this.pendingTrackerClient=null),this.peers.forEach((e=>e.destroy())),this.peers.clear(),this.peerSegmentRequests.clear();for(const e of this.peerCandidates.values())for(const t of e)t.destroy();this.peerCandidates.clear()},this.sendSegmentsMapToAll=e=>{this.peers.forEach((t=>t.sendSegmentsMap(e)))},this.sendSegmentsMap=(e,t)=>{const n=this.peers.get(e);n&&n.sendSegmentsMap(t)},this.getOverallSegmentsMap=()=>{const e=new Map;for(const t of this.peers.values())for(const[n,i]of t.getSegmentsMap())i===h.MediaPeerSegmentStatus.Loaded?e.set(n,h.MediaPeerSegmentStatus.Loaded):e.get(n)||e.set(n,h.MediaPeerSegmentStatus.LoadingByHttp);return e},this.onPieceBytesDownloaded=(e,t,n)=>{const i=this.peerSegmentRequests.get(t);i&&this.emit("bytes-downloaded",i.segment,n,e.id)},this.onPieceBytesUploaded=async(e,t,n)=>{if(void 0===this.masterSwarmId)return;const i=await this.segmentsStorage.getSegment(t,this.masterSwarmId);i&&this.emit("bytes-uploaded",i,n,e.id)},this.onPeerConnect=e=>{if(this.peers.get(e.id))return this.debug("tracker peer already connected (in peer connect)",e.id,e),void e.destroy();this.peers.set(e.id,e);const t=this.peerCandidates.get(e.id);if(t){for(const n of t)n!==e&&n.destroy();this.peerCandidates.delete(e.id)}this.emit("peer-connected",{id:e.id,remoteAddress:e.remoteAddress})},this.onPeerClose=e=>{if(this.peers.get(e.id)!==e){const t=this.peerCandidates.get(e.id);if(!t)return;const n=t.indexOf(e);return-1!==n&&t.splice(n,1),void(0===t.length&&this.peerCandidates.delete(e.id))}for(const[t,n]of this.peerSegmentRequests)n.peerId===e.id&&this.peerSegmentRequests.delete(t);this.peers.delete(e.id),this.emit("peer-data-updated"),this.emit("peer-closed",e.id)},this.onPeerDataUpdated=()=>{this.emit("peer-data-updated")},this.onSegmentRequest=async(e,t)=>{if(void 0===this.masterSwarmId)return;const n=await this.segmentsStorage.getSegment(t,this.masterSwarmId);n&&n.data?e.sendSegmentData(t,n.data):e.sendSegmentAbsent(t)},this.onSegmentLoaded=async(e,t,n)=>{const i=this.peerSegmentRequests.get(t);if(!i)return;const s=i.segment;if(this.settings.segmentValidator)try{await this.settings.segmentValidator(Object.assign(Object.assign({},s),{data:n}),"p2p",e.id)}catch(n){return this.debug("segment validator failed",n),this.peerSegmentRequests.delete(t),this.emit("segment-error",s,n,e.id),void this.onPeerClose(e)}this.peerSegmentRequests.delete(t),this.emit("segment-loaded",s,n,e.id)},this.onSegmentAbsent=(e,t)=>{this.peerSegmentRequests.delete(t),this.emit("peer-data-updated")},this.onSegmentError=(e,t,n)=>{const i=this.peerSegmentRequests.get(t);i&&(this.peerSegmentRequests.delete(t),this.emit("segment-error",i.segment,n,e.id))},this.onSegmentSize=(e,t)=>{const n=this.peerSegmentRequests.get(e);n&&this.emit("segment-size",n.segment,t)},this.onSegmentStartLoad=(e,t)=>{const n=this.peerSegmentRequests.get(e);n&&this.emit("segment-start-load",n.segment,t)},this.onSegmentTimeout=(e,t)=>{const n=this.peerSegmentRequests.get(t);n&&(this.peerSegmentRequests.delete(t),e.destroy(),this.peers.delete(n.peerId)&&this.emit("peer-data-updated"))},this.peerId=t.useP2P?function(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t=u;for(let n=0;n<20-u.length;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return(new TextEncoder).encode(t).buffer}():new ArrayBuffer(0),this.debug.enabled&&this.debug("peer ID",this.getPeerId(),(new TextDecoder).decode(this.peerId))}}n.P2PMediaManager=g},{"./index":14,"./media-peer":16,"./stringly-typed-event-emitter":19,"bittorrent-tracker/client":22,buffer:"buffer",debug:"debug","sha.js/sha1":40}],18:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.SegmentsMemoryStorage=void 0;n.SegmentsMemoryStorage=class{constructor(e){this.settings=e,this.cache=new Map,this.storeSegment=async e=>{this.cache.set(e.id,{segment:e,lastAccessed:performance.now()})},this.getSegmentsMap=async()=>this.cache,this.getSegment=async e=>{const t=this.cache.get(e);if(void 0!==t)return t.lastAccessed=performance.now(),t.segment},this.hasSegment=async e=>this.cache.has(e),this.clean=async(e,t)=>{const n=[],i=[],s=performance.now();for(const e of this.cache.values())s-e.lastAccessed>this.settings.cachedSegmentExpiration?n.push(e.segment.id):i.push(e);let r=i.length-this.settings.cachedSegmentsCount;if(r>0){i.sort(((e,t)=>e.lastAccessed-t.lastAccessed));for(const e of i)if((void 0===t||!t(e.segment.id))&&(n.push(e.segment.id),r--,0===r))break}return n.forEach((e=>this.cache.delete(e))),n.length>0},this.destroy=async()=>{this.cache.clear()}}}},{}],19:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.STEEmitter=void 0;const i=e("events");class s extends i.EventEmitter{constructor(){super(...arguments),this.on=(e,t)=>super.on(e,t),this.emit=(e,...t)=>super.emit(e,...t)}}n.STEEmitter=s},{events:"events"}],20:[function(e,t,n){(function(i){(function(){"use strict";var s=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(e){for(var t=(a=e,r.default.atob?r.default.atob(a):i.from(a,"base64").toString("binary")),n=new Uint8Array(t.length),s=0;s<t.length;s++)n[s]=t.charCodeAt(s);var a;return n};var r=s(e("global/window"));t.exports=n.default}).call(this)}).call(this,e("buffer").Buffer)},{"@babel/runtime/helpers/interopRequireDefault":9,buffer:"buffer","global/window":30}],21:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var i=function(){function e(){this.listeners={}}var t=e.prototype;return t.on=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},t.off=function(e,t){if(!this.listeners[e])return!1;var n=this.listeners[e].indexOf(t);return this.listeners[e]=this.listeners[e].slice(0),this.listeners[e].splice(n,1),n>-1},t.trigger=function(e){var t=this.listeners[e];if(t)if(2===arguments.length)for(var n=t.length,i=0;i<n;++i)t[i].call(this,arguments[1]);else for(var s=Array.prototype.slice.call(arguments,1),r=t.length,a=0;a<r;++a)t[a].apply(this,s)},t.dispose=function(){this.listeners={}},t.pipe=function(e){this.on("data",(function(t){e.push(t)}))},e}();n.default=i,t.exports=n.default},{}],22:[function(e,t,n){(function(n,i){(function(){const s=e("debug")("bittorrent-tracker:client"),r=e("events"),a=e("once"),o=e("run-parallel"),d=e("simple-peer"),h=e("queue-microtask"),l=e("./lib/common"),u=e("./lib/client/http-tracker"),c=e("./lib/client/udp-tracker"),g=e("./lib/client/websocket-tracker");class f extends r{constructor(e={}){if(super(),!e.peerId)throw new Error("Option `peerId` is required");if(!e.infoHash)throw new Error("Option `infoHash` is required");if(!e.announce)throw new Error("Option `announce` is required");if(!n.browser&&!e.port)throw new Error("Option `port` is required");this.peerId="string"==typeof e.peerId?e.peerId:e.peerId.toString("hex"),this._peerIdBuffer=i.from(this.peerId,"hex"),this._peerIdBinary=this._peerIdBuffer.toString("binary"),this.infoHash="string"==typeof e.infoHash?e.infoHash.toLowerCase():e.infoHash.toString("hex"),this._infoHashBuffer=i.from(this.infoHash,"hex"),this._infoHashBinary=this._infoHashBuffer.toString("binary"),s("new client %s",this.infoHash),this.destroyed=!1,this._port=e.port,this._getAnnounceOpts=e.getAnnounceOpts,this._rtcConfig=e.rtcConfig,this._userAgent=e.userAgent,this._proxyOpts=e.proxyOpts,this._wrtc="function"==typeof e.wrtc?e.wrtc():e.wrtc;let t="string"==typeof e.announce?[e.announce]:null==e.announce?[]:e.announce;t=t.map((e=>("/"===(e=e.toString())[e.length-1]&&(e=e.substring(0,e.length-1)),e))),t=Array.from(new Set(t));const r=!1!==this._wrtc&&(!!this._wrtc||d.WEBRTC_SUPPORT),a=e=>{h((()=>{this.emit("warning",e)}))};this._trackers=t.map((e=>{let t;try{t=l.parseUrl(e)}catch(t){return a(new Error(`Invalid tracker URL: ${e}`)),null}const n=t.port;if(n<0||n>65535)return a(new Error(`Invalid tracker port: ${e}`)),null;const i=t.protocol;return"http:"!==i&&"https:"!==i||"function"!=typeof u?"udp:"===i&&"function"==typeof c?new c(this,e):"ws:"!==i&&"wss:"!==i||!r||"ws:"===i&&"undefined"!=typeof window&&"https:"===window.location.protocol?(a(new Error(`Unsupported tracker protocol: ${e}`)),null):new g(this,e):new u(this,e)})).filter(Boolean)}start(e){(e=this._defaultAnnounceOpts(e)).event="started",s("send `start` %o",e),this._announce(e),this._trackers.forEach((e=>{e.setInterval()}))}stop(e){(e=this._defaultAnnounceOpts(e)).event="stopped",s("send `stop` %o",e),this._announce(e)}complete(e){e||(e={}),(e=this._defaultAnnounceOpts(e)).event="completed",s("send `complete` %o",e),this._announce(e)}update(e){(e=this._defaultAnnounceOpts(e)).event&&delete e.event,s("send `update` %o",e),this._announce(e)}_announce(e){this._trackers.forEach((t=>{t.announce(e)}))}scrape(e){s("send `scrape`"),e||(e={}),this._trackers.forEach((t=>{t.scrape(e)}))}setInterval(e){s("setInterval %d",e),this._trackers.forEach((t=>{t.setInterval(e)}))}destroy(e){if(this.destroyed)return;this.destroyed=!0,s("destroy");const t=this._trackers.map((e=>t=>{e.destroy(t)}));o(t,e),this._trackers=[],this._getAnnounceOpts=null}_defaultAnnounceOpts(e={}){return null==e.numwant&&(e.numwant=l.DEFAULT_ANNOUNCE_PEERS),null==e.uploaded&&(e.uploaded=0),null==e.downloaded&&(e.downloaded=0),this._getAnnounceOpts&&(e=Object.assign({},e,this._getAnnounceOpts())),e}}f.scrape=(e,t)=>{if(t=a(t),!e.infoHash)throw new Error("Option `infoHash` is required");if(!e.announce)throw new Error("Option `announce` is required");const n=Object.assign({},e,{infoHash:Array.isArray(e.infoHash)?e.infoHash[0]:e.infoHash,peerId:i.from("01234567890123456789"),port:6881}),s=new f(n);s.once("error",t),s.once("warning",t);let r=Array.isArray(e.infoHash)?e.infoHash.length:1;const o={};return s.on("scrape",(e=>{if(r-=1,o[e.infoHash]=e,0===r){s.destroy();const e=Object.keys(o);1===e.length?t(null,o[e[0]]):t(null,o)}})),e.infoHash=Array.isArray(e.infoHash)?e.infoHash.map((e=>i.from(e,"hex"))):i.from(e.infoHash,"hex"),s.scrape({infoHash:e.infoHash}),s},t.exports=f}).call(this)}).call(this,e("_process"),e("buffer").Buffer)},{"./lib/client/http-tracker":26,"./lib/client/udp-tracker":26,"./lib/client/websocket-tracker":24,"./lib/common":25,_process:34,buffer:"buffer",debug:"debug",events:"events",once:33,"queue-microtask":35,"run-parallel":37,"simple-peer":41}],23:[function(e,t,n){const i=e("events");t.exports=class extends i{constructor(e,t){super(),this.client=e,this.announceUrl=t,this.interval=null,this.destroyed=!1}setInterval(e){null==e&&(e=this.DEFAULT_ANNOUNCE_INTERVAL),clearInterval(this.interval),e&&(this.interval=setInterval((()=>{this.announce(this.client._defaultAnnounceOpts())}),e),this.interval.unref&&this.interval.unref())}}},{events:"events"}],24:[function(e,t,n){const i=e("clone"),s=e("debug")("bittorrent-tracker:websocket-tracker"),r=e("simple-peer"),a=e("randombytes"),o=e("simple-websocket"),d=e("socks"),h=e("../common"),l=e("./tracker"),u={};class c extends l{constructor(e,t){super(e,t),s("new websocket tracker %s",t),this.peers={},this.socket=null,this.reconnecting=!1,this.retries=0,this.reconnectTimer=null,this.expectingResponse=!1,this._openSocket()}announce(e){if(this.destroyed||this.reconnecting)return;if(!this.socket.connected)return void this.socket.once("connect",(()=>{this.announce(e)}));const t=Object.assign({},e,{action:"announce",info_hash:this.client._infoHashBinary,peer_id:this.client._peerIdBinary});if(this._trackerId&&(t.trackerid=this._trackerId),"stopped"===e.event||"completed"===e.event)this._send(t);else{const n=Math.min(e.numwant,5);this._generateOffers(n,(e=>{t.numwant=n,t.offers=e,this._send(t)}))}}scrape(e){if(this.destroyed||this.reconnecting)return;if(!this.socket.connected)return void this.socket.once("connect",(()=>{this.scrape(e)}));const t={action:"scrape",info_hash:Array.isArray(e.infoHash)&&e.infoHash.length>0?e.infoHash.map((e=>e.toString("binary"))):e.infoHash&&e.infoHash.toString("binary")||this.client._infoHashBinary};this._send(t)}destroy(e=g){if(this.destroyed)return e(null);this.destroyed=!0,clearInterval(this.interval),clearTimeout(this.reconnectTimer);for(const e in this.peers){const t=this.peers[e];clearTimeout(t.trackerTimeout),t.destroy()}if(this.peers=null,this.socket&&(this.socket.removeListener("connect",this._onSocketConnectBound),this.socket.removeListener("data",this._onSocketDataBound),this.socket.removeListener("close",this._onSocketCloseBound),this.socket.removeListener("error",this._onSocketErrorBound),this.socket=null),this._onSocketConnectBound=null,this._onSocketErrorBound=null,this._onSocketDataBound=null,this._onSocketCloseBound=null,u[this.announceUrl]&&(u[this.announceUrl].consumers-=1),u[this.announceUrl].consumers>0)return e();let t,n=u[this.announceUrl];if(delete u[this.announceUrl],n.on("error",g),n.once("close",e),!this.expectingResponse)return i();function i(){t&&(clearTimeout(t),t=null),n.removeListener("data",i),n.destroy(),n=null}t=setTimeout(i,h.DESTROY_TIMEOUT),n.once("data",i)}_openSocket(){if(this.destroyed=!1,this.peers||(this.peers={}),this._onSocketConnectBound=()=>{this._onSocketConnect()},this._onSocketErrorBound=e=>{this._onSocketError(e)},this._onSocketDataBound=e=>{this._onSocketData(e)},this._onSocketCloseBound=()=>{this._onSocketClose()},this.socket=u[this.announceUrl],this.socket)u[this.announceUrl].consumers+=1,this.socket.connected&&this._onSocketConnectBound();else{const e=new URL(this.announceUrl);let t;this.client._proxyOpts&&(t="wss:"===e.protocol?this.client._proxyOpts.httpsAgent:this.client._proxyOpts.httpAgent,!t&&this.client._proxyOpts.socksProxy&&(t=new d.Agent(i(this.client._proxyOpts.socksProxy),"wss:"===e.protocol))),this.socket=u[this.announceUrl]=new o({url:this.announceUrl,agent:t}),this.socket.consumers=1,this.socket.once("connect",this._onSocketConnectBound)}this.socket.on("data",this._onSocketDataBound),this.socket.once("close",this._onSocketCloseBound),this.socket.once("error",this._onSocketErrorBound)}_onSocketConnect(){this.destroyed||this.reconnecting&&(this.reconnecting=!1,this.retries=0,this.announce(this.client._defaultAnnounceOpts()))}_onSocketData(e){if(!this.destroyed){this.expectingResponse=!1;try{e=JSON.parse(e)}catch(e){return void this.client.emit("warning",new Error("Invalid tracker response"))}"announce"===e.action?this._onAnnounceResponse(e):"scrape"===e.action?this._onScrapeResponse(e):this._onSocketError(new Error(`invalid action in WS response: ${e.action}`))}}_onAnnounceResponse(e){if(e.info_hash!==this.client._infoHashBinary)return void s("ignoring websocket data from %s for %s (looking for %s: reused socket)",this.announceUrl,h.binaryToHex(e.info_hash),this.client.infoHash);if(e.peer_id&&e.peer_id===this.client._peerIdBinary)return;s("received %s from %s for %s",JSON.stringify(e),this.announceUrl,this.client.infoHash);const t=e["failure reason"];if(t)return this.client.emit("warning",new Error(t));const n=e["warning message"];n&&this.client.emit("warning",new Error(n));const i=e.interval||e["min interval"];i&&this.setInterval(1e3*i);const r=e["tracker id"];if(r&&(this._trackerId=r),null!=e.complete){const t=Object.assign({},e,{announce:this.announceUrl,infoHash:h.binaryToHex(e.info_hash)});this.client.emit("update",t)}let a;if(e.offer&&e.peer_id&&(s("creating peer (from remote offer)"),a=this._createPeer(),a.id=h.binaryToHex(e.peer_id),a.once("signal",(t=>{const n={action:"announce",info_hash:this.client._infoHashBinary,peer_id:this.client._peerIdBinary,to_peer_id:e.peer_id,answer:t,offer_id:e.offer_id};this._trackerId&&(n.trackerid=this._trackerId),this._send(n)})),this.client.emit("peer",a),a.signal(e.offer)),e.answer&&e.peer_id){const t=h.binaryToHex(e.offer_id);a=this.peers[t],a?(a.id=h.binaryToHex(e.peer_id),this.client.emit("peer",a),a.signal(e.answer),clearTimeout(a.trackerTimeout),a.trackerTimeout=null,delete this.peers[t]):s(`got unexpected answer: ${JSON.stringify(e.answer)}`)}}_onScrapeResponse(e){e=e.files||{};const t=Object.keys(e);0!==t.length?t.forEach((t=>{const n=Object.assign(e[t],{announce:this.announceUrl,infoHash:h.binaryToHex(t)});this.client.emit("scrape",n)})):this.client.emit("warning",new Error("invalid scrape response"))}_onSocketClose(){this.destroyed||(this.destroy(),this._startReconnectTimer())}_onSocketError(e){this.destroyed||(this.destroy(),this.client.emit("warning",e),this._startReconnectTimer())}_startReconnectTimer(){const e=Math.floor(3e5*Math.random())+Math.min(1e4*Math.pow(2,this.retries),36e5);this.reconnecting=!0,clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout((()=>{this.retries++,this._openSocket()}),e),this.reconnectTimer.unref&&this.reconnectTimer.unref(),s("reconnecting socket in %s ms",e)}_send(e){if(this.destroyed)return;this.expectingResponse=!0;const t=JSON.stringify(e);s("send %s",t),this.socket.send(t)}_generateOffers(e,t){const n=this,i=[];s("generating %s offers",e);for(let t=0;t<e;++t)r();function r(){const e=a(20).toString("hex");s("creating peer (from _generateOffers)");const t=n.peers[e]=n._createPeer({initiator:!0});t.once("signal",(t=>{i.push({offer:t,offer_id:h.hexToBinary(e)}),o()})),t.trackerTimeout=setTimeout((()=>{s("tracker timeout: destroying peer"),t.trackerTimeout=null,delete n.peers[e],t.destroy()}),5e4),t.trackerTimeout.unref&&t.trackerTimeout.unref()}function o(){i.length===e&&(s("generated %s offers",e),t(i))}o()}_createPeer(e){const t=this;e=Object.assign({trickle:!1,config:t.client._rtcConfig,wrtc:t.client._wrtc},e);const n=new r(e);return n.once("error",i),n.once("connect",(function e(){n.removeListener("error",i),n.removeListener("connect",e)})),n;function i(e){t.client.emit("warning",new Error(`Connection error: ${e.message}`)),n.destroy()}}}function g(){}c.prototype.DEFAULT_ANNOUNCE_INTERVAL=3e4,c._socketPool=u,t.exports=c},{"../common":25,"./tracker":23,clone:27,debug:"debug",randombytes:36,"simple-peer":41,"simple-websocket":57,socks:26}],25:[function(e,t,n){(function(t){(function(){n.DEFAULT_ANNOUNCE_PEERS=50,n.MAX_ANNOUNCE_PEERS=82,n.binaryToHex=e=>("string"!=typeof e&&(e=String(e)),t.from(e,"binary").toString("hex")),n.hexToBinary=e=>("string"!=typeof e&&(e=String(e)),t.from(e,"hex").toString("binary")),n.parseUrl=e=>{const t=new URL(e.replace(/^udp:/,"http:"));return e.match(/^udp:/)&&Object.defineProperties(t,{href:{value:t.href.replace(/^http/,"udp")},protocol:{value:t.protocol.replace(/^http/,"udp")},origin:{value:t.origin.replace(/^http/,"udp")}}),t};const i=e("./common-node");Object.assign(n,i)}).call(this)}).call(this,e("buffer").Buffer)},{"./common-node":26,buffer:"buffer"}],26:[function(e,t,n){},{}],27:[function(e,t,n){(function(e){(function(){var n=function(){"use strict";function t(e,t){return null!=t&&e instanceof t}var n,i,s;try{n=Map}catch(e){n=function(){}}try{i=Set}catch(e){i=function(){}}try{s=Promise}catch(e){s=function(){}}function r(a,d,h,l,u){"object"==typeof d&&(h=d.depth,l=d.prototype,u=d.includeNonEnumerable,d=d.circular);var c=[],g=[],f=void 0!==e;return void 0===d&&(d=!0),void 0===h&&(h=1/0),function a(h,p){if(null===h)return null;if(0===p)return h;var m,b;if("object"!=typeof h)return h;if(t(h,n))m=new n;else if(t(h,i))m=new i;else if(t(h,s))m=new s((function(e,t){h.then((function(t){e(a(t,p-1))}),(function(e){t(a(e,p-1))}))}));else if(r.__isArray(h))m=[];else if(r.__isRegExp(h))m=new RegExp(h.source,o(h)),h.lastIndex&&(m.lastIndex=h.lastIndex);else if(r.__isDate(h))m=new Date(h.getTime());else{if(f&&e.isBuffer(h))return m=e.allocUnsafe?e.allocUnsafe(h.length):new e(h.length),h.copy(m),m;t(h,Error)?m=Object.create(h):void 0===l?(b=Object.getPrototypeOf(h),m=Object.create(b)):(m=Object.create(l),b=l)}if(d){var y=c.indexOf(h);if(-1!=y)return g[y];c.push(h),g.push(m)}for(var _ in t(h,n)&&h.forEach((function(e,t){var n=a(t,p-1),i=a(e,p-1);m.set(n,i)})),t(h,i)&&h.forEach((function(e){var t=a(e,p-1);m.add(t)})),h){var w;b&&(w=Object.getOwnPropertyDescriptor(b,_)),w&&null==w.set||(m[_]=a(h[_],p-1))}if(Object.getOwnPropertySymbols){var S=Object.getOwnPropertySymbols(h);for(_=0;_<S.length;_++){var v=S[_];(!(T=Object.getOwnPropertyDescriptor(h,v))||T.enumerable||u)&&(m[v]=a(h[v],p-1),T.enumerable||Object.defineProperty(m,v,{enumerable:!1}))}}if(u){var E=Object.getOwnPropertyNames(h);for(_=0;_<E.length;_++){var T,R=E[_];(T=Object.getOwnPropertyDescriptor(h,R))&&T.enumerable||(m[R]=a(h[R],p-1),Object.defineProperty(m,R,{enumerable:!1}))}}return m}(a,h)}function a(e){return Object.prototype.toString.call(e)}function o(e){var t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),t}return r.clonePrototype=function(e){if(null===e)return null;var t=function(){};return t.prototype=e,new t},r.__objToStr=a,r.__isDate=function(e){return"object"==typeof e&&"[object Date]"===a(e)},r.__isArray=function(e){return"object"==typeof e&&"[object Array]"===a(e)},r.__isRegExp=function(e){return"object"==typeof e&&"[object RegExp]"===a(e)},r.__getRegExpFlags=o,r}();"object"==typeof t&&t.exports&&(t.exports=n)}).call(this)}).call(this,e("buffer").Buffer)},{buffer:"buffer"}],28:[function(e,t,n){"use strict";function i(e,t){for(const n in t)Object.defineProperty(e,n,{value:t[n],enumerable:!0,configurable:!0});return e}t.exports=function(e,t,n){if(!e||"string"==typeof e)throw new TypeError("Please pass an Error to err-code");n||(n={}),"object"==typeof t&&(n=t,t=""),t&&(n.code=t);try{return i(e,n)}catch(t){n.message=e.message,n.stack=e.stack;const s=function(){};s.prototype=Object.create(Object.getPrototypeOf(e));return i(new s,n)}}},{}],29:[function(e,t,n){t.exports=function(){if("undefined"==typeof globalThis)return null;var e={RTCPeerConnection:globalThis.RTCPeerConnection||globalThis.mozRTCPeerConnection||globalThis.webkitRTCPeerConnection,RTCSessionDescription:globalThis.RTCSessionDescription||globalThis.mozRTCSessionDescription||globalThis.webkitRTCSessionDescription,RTCIceCandidate:globalThis.RTCIceCandidate||globalThis.mozRTCIceCandidate||globalThis.webkitRTCIceCandidate};return e.RTCPeerConnection?e:null}},{}],30:[function(e,t,n){(function(e){(function(){var n;n="undefined"!=typeof window?window:void 0!==e?e:"undefined"!=typeof self?self:{},t.exports=n}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],31:[function(e,t,n){"function"==typeof Object.create?t.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:t.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}}},{}],32:[function(e,t,n){
/*! @name m3u8-parser @version 4.7.1 @license Apache-2.0 */
"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("@babel/runtime/helpers/inheritsLoose"),s=e("@videojs/vhs-utils/cjs/stream.js"),r=e("@babel/runtime/helpers/extends"),a=e("@babel/runtime/helpers/assertThisInitialized"),o=e("@videojs/vhs-utils/cjs/decode-b64-to-uint8-array.js");function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var h=d(i),l=d(s),u=d(r),c=d(a),g=d(o),f=function(e){function t(){var t;return(t=e.call(this)||this).buffer="",t}return h.default(t,e),t.prototype.push=function(e){var t;for(this.buffer+=e,t=this.buffer.indexOf("\n");t>-1;t=this.buffer.indexOf("\n"))this.trigger("data",this.buffer.substring(0,t)),this.buffer=this.buffer.substring(t+1)},t}(l.default),p=String.fromCharCode(9),m=function(e){var t=/([0-9.]*)?@?([0-9.]*)?/.exec(e||""),n={};return t[1]&&(n.length=parseInt(t[1],10)),t[2]&&(n.offset=parseInt(t[2],10)),n},b=function(e){for(var t,n=e.split(new RegExp('(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))')),i={},s=n.length;s--;)""!==n[s]&&((t=/([^=]*)=(.*)/.exec(n[s]).slice(1))[0]=t[0].replace(/^\s+|\s+$/g,""),t[1]=t[1].replace(/^\s+|\s+$/g,""),t[1]=t[1].replace(/^['"](.*)['"]$/g,"$1"),i[t[0]]=t[1]);return i},y=function(e){function t(){var t;return(t=e.call(this)||this).customParsers=[],t.tagMappers=[],t}h.default(t,e);var n=t.prototype;return n.push=function(e){var t,n,i=this;0!==(e=e.trim()).length&&("#"===e[0]?this.tagMappers.reduce((function(t,n){var i=n(e);return i===e?t:t.concat([i])}),[e]).forEach((function(e){for(var s=0;s<i.customParsers.length;s++)if(i.customParsers[s].call(i,e))return;if(0===e.indexOf("#EXT"))if(e=e.replace("\r",""),t=/^#EXTM3U/.exec(e))i.trigger("data",{type:"tag",tagType:"m3u"});else{if(t=/^#EXTINF:?([0-9\.]*)?,?(.*)?$/.exec(e))return n={type:"tag",tagType:"inf"},t[1]&&(n.duration=parseFloat(t[1])),t[2]&&(n.title=t[2]),void i.trigger("data",n);if(t=/^#EXT-X-TARGETDURATION:?([0-9.]*)?/.exec(e))return n={type:"tag",tagType:"targetduration"},t[1]&&(n.duration=parseInt(t[1],10)),void i.trigger("data",n);if(t=/^#EXT-X-VERSION:?([0-9.]*)?/.exec(e))return n={type:"tag",tagType:"version"},t[1]&&(n.version=parseInt(t[1],10)),void i.trigger("data",n);if(t=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(e))return n={type:"tag",tagType:"media-sequence"},t[1]&&(n.number=parseInt(t[1],10)),void i.trigger("data",n);if(t=/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/.exec(e))return n={type:"tag",tagType:"discontinuity-sequence"},t[1]&&(n.number=parseInt(t[1],10)),void i.trigger("data",n);if(t=/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/.exec(e))return n={type:"tag",tagType:"playlist-type"},t[1]&&(n.playlistType=t[1]),void i.trigger("data",n);if(t=/^#EXT-X-BYTERANGE:?(.*)?$/.exec(e))return n=u.default(m(t[1]),{type:"tag",tagType:"byterange"}),void i.trigger("data",n);if(t=/^#EXT-X-ALLOW-CACHE:?(YES|NO)?/.exec(e))return n={type:"tag",tagType:"allow-cache"},t[1]&&(n.allowed=!/NO/.test(t[1])),void i.trigger("data",n);if(t=/^#EXT-X-MAP:?(.*)$/.exec(e)){if(n={type:"tag",tagType:"map"},t[1]){var r=b(t[1]);r.URI&&(n.uri=r.URI),r.BYTERANGE&&(n.byterange=m(r.BYTERANGE))}i.trigger("data",n)}else if(t=/^#EXT-X-STREAM-INF:?(.*)$/.exec(e)){if(n={type:"tag",tagType:"stream-inf"},t[1]){if(n.attributes=b(t[1]),n.attributes.RESOLUTION){var a=n.attributes.RESOLUTION.split("x"),o={};a[0]&&(o.width=parseInt(a[0],10)),a[1]&&(o.height=parseInt(a[1],10)),n.attributes.RESOLUTION=o}n.attributes.BANDWIDTH&&(n.attributes.BANDWIDTH=parseInt(n.attributes.BANDWIDTH,10)),n.attributes["PROGRAM-ID"]&&(n.attributes["PROGRAM-ID"]=parseInt(n.attributes["PROGRAM-ID"],10))}i.trigger("data",n)}else{if(t=/^#EXT-X-MEDIA:?(.*)$/.exec(e))return n={type:"tag",tagType:"media"},t[1]&&(n.attributes=b(t[1])),void i.trigger("data",n);if(t=/^#EXT-X-ENDLIST/.exec(e))i.trigger("data",{type:"tag",tagType:"endlist"});else if(t=/^#EXT-X-DISCONTINUITY/.exec(e))i.trigger("data",{type:"tag",tagType:"discontinuity"});else{if(t=/^#EXT-X-PROGRAM-DATE-TIME:?(.*)$/.exec(e))return n={type:"tag",tagType:"program-date-time"},t[1]&&(n.dateTimeString=t[1],n.dateTimeObject=new Date(t[1])),void i.trigger("data",n);if(t=/^#EXT-X-KEY:?(.*)$/.exec(e))return n={type:"tag",tagType:"key"},t[1]&&(n.attributes=b(t[1]),n.attributes.IV&&("0x"===n.attributes.IV.substring(0,2).toLowerCase()&&(n.attributes.IV=n.attributes.IV.substring(2)),n.attributes.IV=n.attributes.IV.match(/.{8}/g),n.attributes.IV[0]=parseInt(n.attributes.IV[0],16),n.attributes.IV[1]=parseInt(n.attributes.IV[1],16),n.attributes.IV[2]=parseInt(n.attributes.IV[2],16),n.attributes.IV[3]=parseInt(n.attributes.IV[3],16),n.attributes.IV=new Uint32Array(n.attributes.IV))),void i.trigger("data",n);if(t=/^#EXT-X-START:?(.*)$/.exec(e))return n={type:"tag",tagType:"start"},t[1]&&(n.attributes=b(t[1]),n.attributes["TIME-OFFSET"]=parseFloat(n.attributes["TIME-OFFSET"]),n.attributes.PRECISE=/YES/.test(n.attributes.PRECISE)),void i.trigger("data",n);if(t=/^#EXT-X-CUE-OUT-CONT:?(.*)?$/.exec(e))return n={type:"tag",tagType:"cue-out-cont"},t[1]?n.data=t[1]:n.data="",void i.trigger("data",n);if(t=/^#EXT-X-CUE-OUT:?(.*)?$/.exec(e))return n={type:"tag",tagType:"cue-out"},t[1]?n.data=t[1]:n.data="",void i.trigger("data",n);if(t=/^#EXT-X-CUE-IN:?(.*)?$/.exec(e))return n={type:"tag",tagType:"cue-in"},t[1]?n.data=t[1]:n.data="",void i.trigger("data",n);if((t=/^#EXT-X-SKIP:(.*)$/.exec(e))&&t[1])return(n={type:"tag",tagType:"skip"}).attributes=b(t[1]),n.attributes.hasOwnProperty("SKIPPED-SEGMENTS")&&(n.attributes["SKIPPED-SEGMENTS"]=parseInt(n.attributes["SKIPPED-SEGMENTS"],10)),n.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES")&&(n.attributes["RECENTLY-REMOVED-DATERANGES"]=n.attributes["RECENTLY-REMOVED-DATERANGES"].split(p)),void i.trigger("data",n);if((t=/^#EXT-X-PART:(.*)$/.exec(e))&&t[1])return(n={type:"tag",tagType:"part"}).attributes=b(t[1]),["DURATION"].forEach((function(e){n.attributes.hasOwnProperty(e)&&(n.attributes[e]=parseFloat(n.attributes[e]))})),["INDEPENDENT","GAP"].forEach((function(e){n.attributes.hasOwnProperty(e)&&(n.attributes[e]=/YES/.test(n.attributes[e]))})),n.attributes.hasOwnProperty("BYTERANGE")&&(n.attributes.byterange=m(n.attributes.BYTERANGE)),void i.trigger("data",n);if((t=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(e))&&t[1])return(n={type:"tag",tagType:"server-control"}).attributes=b(t[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach((function(e){n.attributes.hasOwnProperty(e)&&(n.attributes[e]=parseFloat(n.attributes[e]))})),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach((function(e){n.attributes.hasOwnProperty(e)&&(n.attributes[e]=/YES/.test(n.attributes[e]))})),void i.trigger("data",n);if((t=/^#EXT-X-PART-INF:(.*)$/.exec(e))&&t[1])return(n={type:"tag",tagType:"part-inf"}).attributes=b(t[1]),["PART-TARGET"].forEach((function(e){n.attributes.hasOwnProperty(e)&&(n.attributes[e]=parseFloat(n.attributes[e]))})),void i.trigger("data",n);if((t=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(e))&&t[1])return(n={type:"tag",tagType:"preload-hint"}).attributes=b(t[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach((function(e){if(n.attributes.hasOwnProperty(e)){n.attributes[e]=parseInt(n.attributes[e],10);var t="BYTERANGE-LENGTH"===e?"length":"offset";n.attributes.byterange=n.attributes.byterange||{},n.attributes.byterange[t]=n.attributes[e],delete n.attributes[e]}})),void i.trigger("data",n);if((t=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(e))&&t[1])return(n={type:"tag",tagType:"rendition-report"}).attributes=b(t[1]),["LAST-MSN","LAST-PART"].forEach((function(e){n.attributes.hasOwnProperty(e)&&(n.attributes[e]=parseInt(n.attributes[e],10))})),void i.trigger("data",n);i.trigger("data",{type:"tag",data:e.slice(4)})}}}else i.trigger("data",{type:"comment",text:e.slice(1)})})):this.trigger("data",{type:"uri",uri:e}))},n.addParser=function(e){var t=this,n=e.expression,i=e.customType,s=e.dataParser,r=e.segment;"function"!=typeof s&&(s=function(e){return e}),this.customParsers.push((function(e){if(n.exec(e))return t.trigger("data",{type:"custom",data:s(e),customType:i,segment:r}),!0}))},n.addTagMapper=function(e){var t=e.expression,n=e.map;this.tagMappers.push((function(e){return t.test(e)?n(e):e}))},t}(l.default),_=function(e){var t={};return Object.keys(e).forEach((function(n){var i;t[(i=n,i.toLowerCase().replace(/-(\w)/g,(function(e){return e[1].toUpperCase()})))]=e[n]})),t},w=function(e){var t=e.serverControl,n=e.targetDuration,i=e.partTargetDuration;if(t){var s="#EXT-X-SERVER-CONTROL",r="holdBack",a="partHoldBack",o=n&&3*n,d=i&&2*i;n&&!t.hasOwnProperty(r)&&(t[r]=o,this.trigger("info",{message:s+" defaulting HOLD-BACK to targetDuration * 3 ("+o+")."})),o&&t[r]<o&&(this.trigger("warn",{message:s+" clamping HOLD-BACK ("+t[r]+") to targetDuration * 3 ("+o+")"}),t[r]=o),i&&!t.hasOwnProperty(a)&&(t[a]=3*i,this.trigger("info",{message:s+" defaulting PART-HOLD-BACK to partTargetDuration * 3 ("+t[a]+")."})),i&&t[a]<d&&(this.trigger("warn",{message:s+" clamping PART-HOLD-BACK ("+t[a]+") to partTargetDuration * 2 ("+d+")."}),t[a]=d)}},S=function(e){function t(){var t;(t=e.call(this)||this).lineStream=new f,t.parseStream=new y,t.lineStream.pipe(t.parseStream);var n,i,s=c.default(t),r=[],a={},o=!1,d=function(){},h={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},l=0;t.manifest={allowCache:!0,discontinuityStarts:[],segments:[]};var p=0,m=0;return t.on("end",(function(){a.uri||!a.parts&&!a.preloadHints||(!a.map&&n&&(a.map=n),!a.key&&i&&(a.key=i),a.timeline||"number"!=typeof l||(a.timeline=l),t.manifest.preloadSegment=a)})),t.parseStream.on("data",(function(e){var t,c;({tag:function(){({version:function(){e.version&&(this.manifest.version=e.version)},"allow-cache":function(){this.manifest.allowCache=e.allowed,"allowed"in e||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange:function(){var t={};"length"in e&&(a.byterange=t,t.length=e.length,"offset"in e||(e.offset=p)),"offset"in e&&(a.byterange=t,t.offset=e.offset),p=t.offset+t.length},endlist:function(){this.manifest.endList=!0},inf:function(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),e.duration>0&&(a.duration=e.duration),0===e.duration&&(a.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=r},key:function(){if(e.attributes)if("NONE"!==e.attributes.METHOD)if(e.attributes.URI){if("com.apple.streamingkeydelivery"===e.attributes.KEYFORMAT)return this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:e.attributes});if("com.microsoft.playready"===e.attributes.KEYFORMAT)return this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.microsoft.playready"]={uri:e.attributes.URI});if("urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===e.attributes.KEYFORMAT){return-1===["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(e.attributes.METHOD)?void this.trigger("warn",{message:"invalid key method provided for Widevine"}):("SAMPLE-AES-CENC"===e.attributes.METHOD&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),"data:text/plain;base64,"!==e.attributes.URI.substring(0,23)?void this.trigger("warn",{message:"invalid key URI provided for Widevine"}):e.attributes.KEYID&&"0x"===e.attributes.KEYID.substring(0,2)?(this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:e.attributes.KEYFORMAT,keyId:e.attributes.KEYID.substring(2)},pssh:g.default(e.attributes.URI.split(",")[1])})):void this.trigger("warn",{message:"invalid key ID provided for Widevine"}))}e.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),i={method:e.attributes.METHOD||"AES-128",uri:e.attributes.URI},void 0!==e.attributes.IV&&(i.iv=e.attributes.IV)}else this.trigger("warn",{message:"ignoring key declaration without URI"});else i=null;else this.trigger("warn",{message:"ignoring key declaration without attribute list"})},"media-sequence":function(){isFinite(e.number)?this.manifest.mediaSequence=e.number:this.trigger("warn",{message:"ignoring invalid media sequence: "+e.number})},"discontinuity-sequence":function(){isFinite(e.number)?(this.manifest.discontinuitySequence=e.number,l=e.number):this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+e.number})},"playlist-type":function(){/VOD|EVENT/.test(e.playlistType)?this.manifest.playlistType=e.playlistType:this.trigger("warn",{message:"ignoring unknown playlist type: "+e.playlist})},map:function(){n={},e.uri&&(n.uri=e.uri),e.byterange&&(n.byterange=e.byterange),i&&(n.key=i)},"stream-inf":function(){this.manifest.playlists=r,this.manifest.mediaGroups=this.manifest.mediaGroups||h,e.attributes?(a.attributes||(a.attributes={}),u.default(a.attributes,e.attributes)):this.trigger("warn",{message:"ignoring empty stream-inf attributes"})},media:function(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||h,e.attributes&&e.attributes.TYPE&&e.attributes["GROUP-ID"]&&e.attributes.NAME){var n=this.manifest.mediaGroups[e.attributes.TYPE];n[e.attributes["GROUP-ID"]]=n[e.attributes["GROUP-ID"]]||{},t=n[e.attributes["GROUP-ID"]],(c={default:/yes/i.test(e.attributes.DEFAULT)}).default?c.autoselect=!0:c.autoselect=/yes/i.test(e.attributes.AUTOSELECT),e.attributes.LANGUAGE&&(c.language=e.attributes.LANGUAGE),e.attributes.URI&&(c.uri=e.attributes.URI),e.attributes["INSTREAM-ID"]&&(c.instreamId=e.attributes["INSTREAM-ID"]),e.attributes.CHARACTERISTICS&&(c.characteristics=e.attributes.CHARACTERISTICS),e.attributes.FORCED&&(c.forced=/yes/i.test(e.attributes.FORCED)),t[e.attributes.NAME]=c}else this.trigger("warn",{message:"ignoring incomplete or missing media group"})},discontinuity:function(){l+=1,a.discontinuity=!0,this.manifest.discontinuityStarts.push(r.length)},"program-date-time":function(){void 0===this.manifest.dateTimeString&&(this.manifest.dateTimeString=e.dateTimeString,this.manifest.dateTimeObject=e.dateTimeObject),a.dateTimeString=e.dateTimeString,a.dateTimeObject=e.dateTimeObject},targetduration:function(){!isFinite(e.duration)||e.duration<0?this.trigger("warn",{message:"ignoring invalid target duration: "+e.duration}):(this.manifest.targetDuration=e.duration,w.call(this,this.manifest))},start:function(){e.attributes&&!isNaN(e.attributes["TIME-OFFSET"])?this.manifest.start={timeOffset:e.attributes["TIME-OFFSET"],precise:e.attributes.PRECISE}:this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"})},"cue-out":function(){a.cueOut=e.data},"cue-out-cont":function(){a.cueOutCont=e.data},"cue-in":function(){a.cueIn=e.data},skip:function(){this.manifest.skip=_(e.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",e.attributes,["SKIPPED-SEGMENTS"])},part:function(){var t=this;o=!0;var n=this.manifest.segments.length,i=_(e.attributes);a.parts=a.parts||[],a.parts.push(i),i.byterange&&(i.byterange.hasOwnProperty("offset")||(i.byterange.offset=m),m=i.byterange.offset+i.byterange.length);var s=a.parts.length-1;this.warnOnMissingAttributes_("#EXT-X-PART #"+s+" for segment #"+n,e.attributes,["URI","DURATION"]),this.manifest.renditionReports&&this.manifest.renditionReports.forEach((function(e,n){e.hasOwnProperty("lastPart")||t.trigger("warn",{message:"#EXT-X-RENDITION-REPORT #"+n+" lacks required attribute(s): LAST-PART"})}))},"server-control":function(){var t=this.manifest.serverControl=_(e.attributes);t.hasOwnProperty("canBlockReload")||(t.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"})),w.call(this,this.manifest),t.canSkipDateranges&&!t.hasOwnProperty("canSkipUntil")&&this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint":function(){var t=this.manifest.segments.length,n=_(e.attributes),i=n.type&&"PART"===n.type;a.preloadHints=a.preloadHints||[],a.preloadHints.push(n),n.byterange&&(n.byterange.hasOwnProperty("offset")||(n.byterange.offset=i?m:0,i&&(m=n.byterange.offset+n.byterange.length)));var s=a.preloadHints.length-1;if(this.warnOnMissingAttributes_("#EXT-X-PRELOAD-HINT #"+s+" for segment #"+t,e.attributes,["TYPE","URI"]),n.type)for(var r=0;r<a.preloadHints.length-1;r++){var o=a.preloadHints[r];o.type&&(o.type===n.type&&this.trigger("warn",{message:"#EXT-X-PRELOAD-HINT #"+s+" for segment #"+t+" has the same TYPE "+n.type+" as preload hint #"+r}))}},"rendition-report":function(){var t=_(e.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(t);var n=this.manifest.renditionReports.length-1,i=["LAST-MSN","URI"];o&&i.push("LAST-PART"),this.warnOnMissingAttributes_("#EXT-X-RENDITION-REPORT #"+n,e.attributes,i)},"part-inf":function(){this.manifest.partInf=_(e.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",e.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget&&(this.manifest.partTargetDuration=this.manifest.partInf.partTarget),w.call(this,this.manifest)}}[e.tagType]||d).call(s)},uri:function(){a.uri=e.uri,r.push(a),this.manifest.targetDuration&&!("duration"in a)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),a.duration=this.manifest.targetDuration),i&&(a.key=i),a.timeline=l,n&&(a.map=n),m=0,a={}},comment:function(){},custom:function(){e.segment?(a.custom=a.custom||{},a.custom[e.customType]=e.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[e.customType]=e.data)}})[e.type].call(s)})),t}h.default(t,e);var n=t.prototype;return n.warnOnMissingAttributes_=function(e,t,n){var i=[];n.forEach((function(e){t.hasOwnProperty(e)||i.push(e)})),i.length&&this.trigger("warn",{message:e+" lacks required attribute(s): "+i.join(", ")})},n.push=function(e){this.lineStream.push(e)},n.end=function(){this.lineStream.push("\n"),this.trigger("end")},n.addParser=function(e){this.parseStream.addParser(e)},n.addTagMapper=function(e){this.parseStream.addTagMapper(e)},t}(l.default);n.LineStream=f,n.ParseStream=y,n.Parser=S},{"@babel/runtime/helpers/assertThisInitialized":6,"@babel/runtime/helpers/extends":7,"@babel/runtime/helpers/inheritsLoose":8,"@videojs/vhs-utils/cjs/decode-b64-to-uint8-array.js":20,"@videojs/vhs-utils/cjs/stream.js":21}],33:[function(e,t,n){var i=e("wrappy");function s(e){var t=function(){return t.called?t.value:(t.called=!0,t.value=e.apply(this,arguments))};return t.called=!1,t}function r(e){var t=function(){if(t.called)throw new Error(t.onceError);return t.called=!0,t.value=e.apply(this,arguments)},n=e.name||"Function wrapped with `once`";return t.onceError=n+" shouldn't be called more than once",t.called=!1,t}t.exports=i(s),t.exports.strict=i(r),s.proto=s((function(){Object.defineProperty(Function.prototype,"once",{value:function(){return s(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return r(this)},configurable:!0})}))},{wrappy:75}],34:[function(e,t,n){var i,s,r=t.exports={};function a(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function d(e){if(i===setTimeout)return setTimeout(e,0);if((i===a||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:a}catch(e){i=a}try{s="function"==typeof clearTimeout?clearTimeout:o}catch(e){s=o}}();var h,l=[],u=!1,c=-1;function g(){u&&h&&(u=!1,h.length?l=h.concat(l):c=-1,l.length&&f())}function f(){if(!u){var e=d(g);u=!0;for(var t=l.length;t;){for(h=l,l=[];++c<t;)h&&h[c].run();c=-1,t=l.length}h=null,u=!1,function(e){if(s===clearTimeout)return clearTimeout(e);if((s===o||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(e);try{s(e)}catch(t){try{return s.call(null,e)}catch(t){return s.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function m(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new p(e,t)),1!==l.length||u||d(f)},p.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=m,r.addListener=m,r.once=m,r.off=m,r.removeListener=m,r.removeAllListeners=m,r.emit=m,r.prependListener=m,r.prependOnceListener=m,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},{}],35:[function(e,t,n){(function(e){(function(){
/*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
let n;t.exports="function"==typeof queueMicrotask?queueMicrotask.bind("undefined"!=typeof window?window:e):e=>(n||(n=Promise.resolve())).then(e).catch((e=>setTimeout((()=>{throw e}),0)))}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],36:[function(e,t,n){(function(n,i){(function(){"use strict";var s=65536,r=4294967295;var a=e("safe-buffer").Buffer,o=i.crypto||i.msCrypto;o&&o.getRandomValues?t.exports=function(e,t){if(e>r)throw new RangeError("requested too many random bytes");var i=a.allocUnsafe(e);if(e>0)if(e>s)for(var d=0;d<e;d+=s)o.getRandomValues(i.slice(d,d+s));else o.getRandomValues(i);if("function"==typeof t)return n.nextTick((function(){t(null,i)}));return i}:t.exports=function(){throw new Error("Secure random number generation is not supported by this browser.\nUse Chrome, Firefox or Internet Explorer 11")}}).call(this)}).call(this,e("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{_process:34,"safe-buffer":38}],37:[function(e,t,n){
/*! run-parallel. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
t.exports=function(e,t){let n,s,r,a=!0;Array.isArray(e)?(n=[],s=e.length):(r=Object.keys(e),n={},s=r.length);function o(e){function s(){t&&t(e,n),t=null}a?i(s):s()}function d(e,t,i){n[e]=i,(0==--s||t)&&o(t)}s?r?r.forEach((function(t){e[t]((function(e,n){d(t,e,n)}))})):e.forEach((function(e,t){e((function(e,n){d(t,e,n)}))})):o(null);a=!1};const i=e("queue-microtask")},{"queue-microtask":35}],38:[function(e,t,n){
/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
var i=e("buffer"),s=i.Buffer;function r(e,t){for(var n in e)t[n]=e[n]}function a(e,t,n){return s(e,t,n)}s.from&&s.alloc&&s.allocUnsafe&&s.allocUnsafeSlow?t.exports=i:(r(i,n),n.Buffer=a),a.prototype=Object.create(s.prototype),r(s,a),a.from=function(e,t,n){if("number"==typeof e)throw new TypeError("Argument must not be a number");return s(e,t,n)},a.alloc=function(e,t,n){if("number"!=typeof e)throw new TypeError("Argument must be a number");var i=s(e);return void 0!==t?"string"==typeof n?i.fill(t,n):i.fill(t):i.fill(0),i},a.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return s(e)},a.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return i.SlowBuffer(e)}},{buffer:"buffer"}],39:[function(e,t,n){var i=e("safe-buffer").Buffer;function s(e,t){this._block=i.alloc(e),this._finalSize=t,this._blockSize=e,this._len=0}s.prototype.update=function(e,t){"string"==typeof e&&(t=t||"utf8",e=i.from(e,t));for(var n=this._block,s=this._blockSize,r=e.length,a=this._len,o=0;o<r;){for(var d=a%s,h=Math.min(r-o,s-d),l=0;l<h;l++)n[d+l]=e[o+l];o+=h,(a+=h)%s==0&&this._update(n)}return this._len+=r,this},s.prototype.digest=function(e){var t=this._len%this._blockSize;this._block[t]=128,this._block.fill(0,t+1),t>=this._finalSize&&(this._update(this._block),this._block.fill(0));var n=8*this._len;if(n<=4294967295)this._block.writeUInt32BE(n,this._blockSize-4);else{var i=(4294967295&n)>>>0,s=(n-i)/4294967296;this._block.writeUInt32BE(s,this._blockSize-8),this._block.writeUInt32BE(i,this._blockSize-4)}this._update(this._block);var r=this._hash();return e?r.toString(e):r},s.prototype._update=function(){throw new Error("_update must be implemented by subclass")},t.exports=s},{"safe-buffer":38}],40:[function(e,t,n){var i=e("inherits"),s=e("./hash"),r=e("safe-buffer").Buffer,a=[1518500249,1859775393,-1894007588,-899497514],o=new Array(80);function d(){this.init(),this._w=o,s.call(this,64,56)}function h(e){return e<<5|e>>>27}function l(e){return e<<30|e>>>2}function u(e,t,n,i){return 0===e?t&n|~t&i:2===e?t&n|t&i|n&i:t^n^i}i(d,s),d.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this},d.prototype._update=function(e){for(var t,n=this._w,i=0|this._a,s=0|this._b,r=0|this._c,o=0|this._d,d=0|this._e,c=0;c<16;++c)n[c]=e.readInt32BE(4*c);for(;c<80;++c)n[c]=(t=n[c-3]^n[c-8]^n[c-14]^n[c-16])<<1|t>>>31;for(var g=0;g<80;++g){var f=~~(g/20),p=h(i)+u(f,s,r,o)+d+n[g]+a[f]|0;d=o,o=r,r=l(s),s=i,i=p}this._a=i+this._a|0,this._b=s+this._b|0,this._c=r+this._c|0,this._d=o+this._d|0,this._e=d+this._e|0},d.prototype._hash=function(){var e=r.allocUnsafe(20);return e.writeInt32BE(0|this._a,0),e.writeInt32BE(0|this._b,4),e.writeInt32BE(0|this._c,8),e.writeInt32BE(0|this._d,12),e.writeInt32BE(0|this._e,16),e},t.exports=d},{"./hash":39,inherits:31,"safe-buffer":38}],41:[function(e,t,n){
/*! simple-peer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
const i=e("debug")("simple-peer"),s=e("get-browser-rtc"),r=e("randombytes"),a=e("readable-stream"),o=e("queue-microtask"),d=e("err-code"),{Buffer:h}=e("buffer"),l=65536;function u(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}class c extends a.Duplex{constructor(e){if(super(e=Object.assign({allowHalfOpen:!1},e)),this._id=r(4).toString("hex").slice(0,7),this._debug("new peer %o",e),this.channelName=e.initiator?e.channelName||r(20).toString("hex"):null,this.initiator=e.initiator||!1,this.channelConfig=e.channelConfig||c.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},c.config,e.config),this.offerOptions=e.offerOptions||{},this.answerOptions=e.answerOptions||{},this.sdpTransform=e.sdpTransform||(e=>e),this.streams=e.streams||(e.stream?[e.stream]:[]),this.trickle=void 0===e.trickle||e.trickle,this.allowHalfTrickle=void 0!==e.allowHalfTrickle&&e.allowHalfTrickle,this.iceCompleteTimeout=e.iceCompleteTimeout||5e3,this.destroyed=!1,this.destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._wrtc=e.wrtc&&"object"==typeof e.wrtc?e.wrtc:s(),!this._wrtc)throw"undefined"==typeof window?d(new Error("No WebRTC support: Specify `opts.wrtc` option in this environment"),"ERR_WEBRTC_SUPPORT"):d(new Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT");this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new this._wrtc.RTCPeerConnection(this.config)}catch(e){return void this.destroy(d(e,"ERR_PC_CONSTRUCTOR"))}this._isReactNativeWebrtc="number"==typeof this._pc._peerConnectionId,this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=e=>{this._onIceCandidate(e)},"object"==typeof this._pc.peerIdentity&&this._pc.peerIdentity.catch((e=>{this.destroy(d(e,"ERR_PC_PEER_IDENTITY"))})),this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=e=>{this._setupData(e)},this.streams&&this.streams.forEach((e=>{this.addStream(e)})),this._pc.ontrack=e=>{this._onTrack(e)},this._debug("initial negotiation"),this._needsNegotiation(),this._onFinishBound=()=>{this._onFinish()},this.once("finish",this._onFinishBound)}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(e){if(!this.destroying){if(this.destroyed)throw d(new Error("cannot signal after peer is destroyed"),"ERR_DESTROYED");if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}this._debug("signal()"),e.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),e.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(e.transceiverRequest.kind,e.transceiverRequest.init)),e.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(e)).then((()=>{this.destroyed||(this._pendingCandidates.forEach((e=>{this._addIceCandidate(e)})),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())})).catch((e=>{this.destroy(d(e,"ERR_SET_REMOTE_DESCRIPTION"))})),e.sdp||e.candidate||e.renegotiate||e.transceiverRequest||this.destroy(d(new Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}}_addIceCandidate(e){const t=new this._wrtc.RTCIceCandidate(e);this._pc.addIceCandidate(t).catch((e=>{var n;!t.address||t.address.endsWith(".local")?(n="Ignoring unsupported ICE candidate.",console.warn(n)):this.destroy(d(e,"ERR_ADD_ICE_CANDIDATE"))}))}send(e){if(!this.destroying){if(this.destroyed)throw d(new Error("cannot send after peer is destroyed"),"ERR_DESTROYED");this._channel.send(e)}}addTransceiver(e,t){if(!this.destroying){if(this.destroyed)throw d(new Error("cannot addTransceiver after peer is destroyed"),"ERR_DESTROYED");if(this._debug("addTransceiver()"),this.initiator)try{this._pc.addTransceiver(e,t),this._needsNegotiation()}catch(e){this.destroy(d(e,"ERR_ADD_TRANSCEIVER"))}else this.emit("signal",{type:"transceiverRequest",transceiverRequest:{kind:e,init:t}})}}addStream(e){if(!this.destroying){if(this.destroyed)throw d(new Error("cannot addStream after peer is destroyed"),"ERR_DESTROYED");this._debug("addStream()"),e.getTracks().forEach((t=>{this.addTrack(t,e)}))}}addTrack(e,t){if(this.destroying)return;if(this.destroyed)throw d(new Error("cannot addTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("addTrack()");const n=this._senderMap.get(e)||new Map;let i=n.get(t);if(i)throw i.removed?d(new Error("Track has been removed. You should enable/disable tracks that you want to re-add."),"ERR_SENDER_REMOVED"):d(new Error("Track has already been added to that stream."),"ERR_SENDER_ALREADY_ADDED");i=this._pc.addTrack(e,t),n.set(t,i),this._senderMap.set(e,n),this._needsNegotiation()}replaceTrack(e,t,n){if(this.destroying)return;if(this.destroyed)throw d(new Error("cannot replaceTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("replaceTrack()");const i=this._senderMap.get(e),s=i?i.get(n):null;if(!s)throw d(new Error("Cannot replace track that was never added."),"ERR_TRACK_NOT_ADDED");t&&this._senderMap.set(t,i),null!=s.replaceTrack?s.replaceTrack(t):this.destroy(d(new Error("replaceTrack is not supported in this browser"),"ERR_UNSUPPORTED_REPLACETRACK"))}removeTrack(e,t){if(this.destroying)return;if(this.destroyed)throw d(new Error("cannot removeTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSender()");const n=this._senderMap.get(e),i=n?n.get(t):null;if(!i)throw d(new Error("Cannot remove track that was never added."),"ERR_TRACK_NOT_ADDED");try{i.removed=!0,this._pc.removeTrack(i)}catch(e){"NS_ERROR_UNEXPECTED"===e.name?this._sendersAwaitingStable.push(i):this.destroy(d(e,"ERR_REMOVE_TRACK"))}this._needsNegotiation()}removeStream(e){if(!this.destroying){if(this.destroyed)throw d(new Error("cannot removeStream after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSenders()"),e.getTracks().forEach((t=>{this.removeTrack(t,e)}))}}_needsNegotiation(){this._debug("_needsNegotiation"),this._batchedNegotiation||(this._batchedNegotiation=!0,o((()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1})))}negotiate(){if(!this.destroying){if(this.destroyed)throw d(new Error("cannot negotiate after peer is destroyed"),"ERR_DESTROYED");this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout((()=>{this._createOffer()}),0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}}destroy(e){this._destroy(e,(()=>{}))}_destroy(e,t){this.destroyed||this.destroying||(this.destroying=!0,this._debug("destroying (error: %s)",e&&(e.message||e)),o((()=>{if(this.destroyed=!0,this.destroying=!1,this._debug("destroy (error: %s)",e&&(e.message||e)),this.readable=this.writable=!1,this._readableState.ended||this.push(null),this._writableState.finished||this.end(),this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._onFinishBound&&this.removeListener("finish",this._onFinishBound),this._onFinishBound=null,this._channel){try{this._channel.close()}catch(e){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(e){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,e&&this.emit("error",e),this.emit("close"),t()})))}_setupData(e){if(!e.channel)return this.destroy(d(new Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=l),this.channelName=this._channel.label,this._channel.onmessage=e=>{this._onChannelMessage(e)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=e=>{const t=e.error instanceof Error?e.error:new Error(`Datachannel error: ${e.message} ${e.filename}:${e.lineno}:${e.colno}`);this.destroy(d(t,"ERR_DATA_CHANNEL"))};let t=!1;this._closingInterval=setInterval((()=>{this._channel&&"closing"===this._channel.readyState?(t&&this._onChannelClose(),t=!0):t=!1}),5e3)}_read(){}_write(e,t,n){if(this.destroyed)return n(d(new Error("cannot write after peer is destroyed"),"ERR_DATA_CHANNEL"));if(this._connected){try{this.send(e)}catch(e){return this.destroy(d(e,"ERR_DATA_CHANNEL"))}this._channel.bufferedAmount>l?(this._debug("start backpressure: bufferedAmount %d",this._channel.bufferedAmount),this._cb=n):n(null)}else this._debug("write before connect"),this._chunk=e,this._cb=n}_onFinish(){if(this.destroyed)return;const e=()=>{setTimeout((()=>this.destroy()),1e3)};this._connected?e():this.once("connect",e)}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout((()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))}),this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=u(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:t.type,sdp:t.sdp})};this._pc.setLocalDescription(e).then((()=>{this._debug("createOffer success"),this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(d(e,"ERR_SET_LOCAL_DESCRIPTION"))}))})).catch((e=>{this.destroy(d(e,"ERR_CREATE_OFFER"))}))}_requestMissingTransceivers(){this._pc.getTransceivers&&this._pc.getTransceivers().forEach((e=>{e.mid||!e.sender.track||e.requested||(e.requested=!0,this.addTransceiver(e.sender.track.kind))}))}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=u(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:t.type,sdp:t.sdp}),this.initiator||this._requestMissingTransceivers()};this._pc.setLocalDescription(e).then((()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(d(e,"ERR_SET_LOCAL_DESCRIPTION"))}))})).catch((e=>{this.destroy(d(e,"ERR_CREATE_ANSWER"))}))}_onConnectionStateChange(){this.destroyed||"failed"===this._pc.connectionState&&this.destroy(d(new Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(this.destroyed)return;const e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",e,t),this.emit("iceStateChange",e,t),"connected"!==e&&"completed"!==e||(this._pcReady=!0,this._maybeReady()),"failed"===e&&this.destroy(d(new Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),"closed"===e&&this.destroy(d(new Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED"))}getStats(e){const t=e=>("[object Array]"===Object.prototype.toString.call(e.values)&&e.values.forEach((t=>{Object.assign(e,t)})),e);0===this._pc.getStats.length||this._isReactNativeWebrtc?this._pc.getStats().then((n=>{const i=[];n.forEach((e=>{i.push(t(e))})),e(null,i)}),(t=>e(t))):this._pc.getStats.length>0?this._pc.getStats((n=>{if(this.destroyed)return;const i=[];n.result().forEach((e=>{const n={};e.names().forEach((t=>{n[t]=e.stat(t)})),n.id=e.id,n.type=e.type,n.timestamp=e.timestamp,i.push(t(n))})),e(null,i)}),(t=>e(t))):e(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const e=()=>{this.destroyed||this.getStats(((t,n)=>{if(this.destroyed)return;t&&(n=[]);const i={},s={},r={};let a=!1;n.forEach((e=>{"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(i[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(s[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(r[e.id]=e)}));const o=e=>{a=!0;let t=s[e.localCandidateId];t&&(t.ip||t.address)?(this.localAddress=t.ip||t.address,this.localPort=Number(t.port)):t&&t.ipAddress?(this.localAddress=t.ipAddress,this.localPort=Number(t.portNumber)):"string"==typeof e.googLocalAddress&&(t=e.googLocalAddress.split(":"),this.localAddress=t[0],this.localPort=Number(t[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let n=i[e.remoteCandidateId];n&&(n.ip||n.address)?(this.remoteAddress=n.ip||n.address,this.remotePort=Number(n.port)):n&&n.ipAddress?(this.remoteAddress=n.ipAddress,this.remotePort=Number(n.portNumber)):"string"==typeof e.googRemoteAddress&&(n=e.googRemoteAddress.split(":"),this.remoteAddress=n[0],this.remotePort=Number(n[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(n.forEach((e=>{"transport"===e.type&&e.selectedCandidatePairId&&o(r[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&o(e)})),a||Object.keys(r).length&&!Object.keys(s).length){if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(t){return this.destroy(d(t,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');const e=this._cb;this._cb=null,e(null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval((()=>this._onInterval()),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")}else setTimeout(e,100)}))};e()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>l||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"===this._pc.signalingState&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach((e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0})),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):e.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(e){if(this.destroyed)return;let t=e.data;t instanceof ArrayBuffer&&(t=h.from(t)),this.push(t)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);const e=this._cb;this._cb=null,e(null)}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.destroy())}_onTrack(e){this.destroyed||e.streams.forEach((t=>{this._debug("on track"),this.emit("track",e.track,t),this._remoteTracks.push({track:e.track,stream:t}),this._remoteStreams.some((e=>e.id===t.id))||(this._remoteStreams.push(t),o((()=>{this._debug("on stream"),this.emit("stream",t)})))}))}_debug(){const e=[].slice.call(arguments);e[0]="["+this._id+"] "+e[0],i.apply(null,e)}}c.WEBRTC_SUPPORT=!!s(),c.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},c.channelConfig={},t.exports=c},{buffer:"buffer",debug:"debug","err-code":28,"get-browser-rtc":29,"queue-microtask":35,randombytes:36,"readable-stream":56}],42:[function(e,t,n){"use strict";var i={};function s(e,t,n){n||(n=Error);var s=function(e){var n,i;function s(n,i,s){return e.call(this,function(e,n,i){return"string"==typeof t?t:t(e,n,i)}(n,i,s))||this}return i=e,(n=s).prototype=Object.create(i.prototype),n.prototype.constructor=n,n.__proto__=i,s}(n);s.prototype.name=n.name,s.prototype.code=e,i[e]=s}function r(e,t){if(Array.isArray(e)){var n=e.length;return e=e.map((function(e){return String(e)})),n>2?"one of ".concat(t," ").concat(e.slice(0,n-1).join(", "),", or ")+e[n-1]:2===n?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}return"of ".concat(t," ").concat(String(e))}s("ERR_INVALID_OPT_VALUE",(function(e,t){return'The value "'+t+'" is invalid for option "'+e+'"'}),TypeError),s("ERR_INVALID_ARG_TYPE",(function(e,t,n){var i,s,a,o;if("string"==typeof t&&(s="not ",t.substr(!a||a<0?0:+a,s.length)===s)?(i="must not be",t=t.replace(/^not /,"")):i="must be",function(e,t,n){return(void 0===n||n>e.length)&&(n=e.length),e.substring(n-t.length,n)===t}(e," argument"))o="The ".concat(e," ").concat(i," ").concat(r(t,"type"));else{var d=function(e,t,n){return"number"!=typeof n&&(n=0),!(n+t.length>e.length)&&-1!==e.indexOf(t,n)}(e,".")?"property":"argument";o='The "'.concat(e,'" ').concat(d," ").concat(i," ").concat(r(t,"type"))}return o+=". Received type ".concat(typeof n)}),TypeError),s("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),s("ERR_METHOD_NOT_IMPLEMENTED",(function(e){return"The "+e+" method is not implemented"})),s("ERR_STREAM_PREMATURE_CLOSE","Premature close"),s("ERR_STREAM_DESTROYED",(function(e){return"Cannot call "+e+" after a stream was destroyed"})),s("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),s("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),s("ERR_STREAM_WRITE_AFTER_END","write after end"),s("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),s("ERR_UNKNOWN_ENCODING",(function(e){return"Unknown encoding: "+e}),TypeError),s("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),t.exports.codes=i},{}],43:[function(e,t,n){(function(n){(function(){"use strict";var i=Object.keys||function(e){var t=[];for(var n in e)t.push(n);return t};t.exports=h;var s=e("./_stream_readable"),r=e("./_stream_writable");e("inherits")(h,s);for(var a=i(r.prototype),o=0;o<a.length;o++){var d=a[o];h.prototype[d]||(h.prototype[d]=r.prototype[d])}function h(e){if(!(this instanceof h))return new h(e);s.call(this,e),r.call(this,e),this.allowHalfOpen=!0,e&&(!1===e.readable&&(this.readable=!1),!1===e.writable&&(this.writable=!1),!1===e.allowHalfOpen&&(this.allowHalfOpen=!1,this.once("end",l)))}function l(){this._writableState.ended||n.nextTick(u,this)}function u(e){e.end()}Object.defineProperty(h.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(h.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(h.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(h.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed&&this._writableState.destroyed)},set:function(e){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=e,this._writableState.destroyed=e)}})}).call(this)}).call(this,e("_process"))},{"./_stream_readable":45,"./_stream_writable":47,_process:34,inherits:31}],44:[function(e,t,n){"use strict";t.exports=s;var i=e("./_stream_transform");function s(e){if(!(this instanceof s))return new s(e);i.call(this,e)}e("inherits")(s,i),s.prototype._transform=function(e,t,n){n(null,e)}},{"./_stream_transform":46,inherits:31}],45:[function(e,t,n){(function(n,i){(function(){"use strict";var s;t.exports=R,R.ReadableState=T;e("events").EventEmitter;var r=function(e,t){return e.listeners(t).length},a=e("./internal/streams/stream"),o=e("buffer").Buffer,d=i.Uint8Array||function(){};var h,l=e("util");h=l&&l.debuglog?l.debuglog("stream"):function(){};var u,c,g,f=e("./internal/streams/buffer_list"),p=e("./internal/streams/destroy"),m=e("./internal/streams/state").getHighWaterMark,b=e("../errors").codes,y=b.ERR_INVALID_ARG_TYPE,_=b.ERR_STREAM_PUSH_AFTER_EOF,w=b.ERR_METHOD_NOT_IMPLEMENTED,S=b.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;e("inherits")(R,a);var v=p.errorOrDestroy,E=["error","close","destroy","pause","resume"];function T(t,n,i){s=s||e("./_stream_duplex"),t=t||{},"boolean"!=typeof i&&(i=n instanceof s),this.objectMode=!!t.objectMode,i&&(this.objectMode=this.objectMode||!!t.readableObjectMode),this.highWaterMark=m(this,t,"readableHighWaterMark",i),this.buffer=new f,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.destroyed=!1,this.defaultEncoding=t.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,t.encoding&&(u||(u=e("string_decoder/").StringDecoder),this.decoder=new u(t.encoding),this.encoding=t.encoding)}function R(t){if(s=s||e("./_stream_duplex"),!(this instanceof R))return new R(t);var n=this instanceof s;this._readableState=new T(t,this,n),this.readable=!0,t&&("function"==typeof t.read&&(this._read=t.read),"function"==typeof t.destroy&&(this._destroy=t.destroy)),a.call(this)}function P(e,t,n,i,s){h("readableAddChunk",t);var r,a=e._readableState;if(null===t)a.reading=!1,function(e,t){if(h("onEofChunk"),t.ended)return;if(t.decoder){var n=t.decoder.end();n&&n.length&&(t.buffer.push(n),t.length+=t.objectMode?1:n.length)}t.ended=!0,t.sync?M(e):(t.needReadable=!1,t.emittedReadable||(t.emittedReadable=!0,C(e)))}(e,a);else if(s||(r=function(e,t){var n;i=t,o.isBuffer(i)||i instanceof d||"string"==typeof t||void 0===t||e.objectMode||(n=new y("chunk",["string","Buffer","Uint8Array"],t));var i;return n}(a,t)),r)v(e,r);else if(a.objectMode||t&&t.length>0)if("string"==typeof t||a.objectMode||Object.getPrototypeOf(t)===o.prototype||(t=function(e){return o.from(e)}(t)),i)a.endEmitted?v(e,new S):I(e,a,t,!0);else if(a.ended)v(e,new _);else{if(a.destroyed)return!1;a.reading=!1,a.decoder&&!n?(t=a.decoder.write(t),a.objectMode||0!==t.length?I(e,a,t,!1):A(e,a)):I(e,a,t,!1)}else i||(a.reading=!1,A(e,a));return!a.ended&&(a.length<a.highWaterMark||0===a.length)}function I(e,t,n,i){t.flowing&&0===t.length&&!t.sync?(t.awaitDrain=0,e.emit("data",n)):(t.length+=t.objectMode?1:n.length,i?t.buffer.unshift(n):t.buffer.push(n),t.needReadable&&M(e)),A(e,t)}Object.defineProperty(R.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(e){this._readableState&&(this._readableState.destroyed=e)}}),R.prototype.destroy=p.destroy,R.prototype._undestroy=p.undestroy,R.prototype._destroy=function(e,t){t(e)},R.prototype.push=function(e,t){var n,i=this._readableState;return i.objectMode?n=!0:"string"==typeof e&&((t=t||i.defaultEncoding)!==i.encoding&&(e=o.from(e,t),t=""),n=!0),P(this,e,t,!1,n)},R.prototype.unshift=function(e){return P(this,e,null,!0,!1)},R.prototype.isPaused=function(){return!1===this._readableState.flowing},R.prototype.setEncoding=function(t){u||(u=e("string_decoder/").StringDecoder);var n=new u(t);this._readableState.decoder=n,this._readableState.encoding=this._readableState.decoder.encoding;for(var i=this._readableState.buffer.head,s="";null!==i;)s+=n.write(i.data),i=i.next;return this._readableState.buffer.clear(),""!==s&&this._readableState.buffer.push(s),this._readableState.length=s.length,this};var k=1073741824;function O(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:e!=e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=function(e){return e>=k?e=k:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}(e)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0))}function M(e){var t=e._readableState;h("emitReadable",t.needReadable,t.emittedReadable),t.needReadable=!1,t.emittedReadable||(h("emitReadable",t.flowing),t.emittedReadable=!0,n.nextTick(C,e))}function C(e){var t=e._readableState;h("emitReadable_",t.destroyed,t.length,t.ended),t.destroyed||!t.length&&!t.ended||(e.emit("readable"),t.emittedReadable=!1),t.needReadable=!t.flowing&&!t.ended&&t.length<=t.highWaterMark,j(e)}function A(e,t){t.readingMore||(t.readingMore=!0,n.nextTick(D,e,t))}function D(e,t){for(;!t.reading&&!t.ended&&(t.length<t.highWaterMark||t.flowing&&0===t.length);){var n=t.length;if(h("maybeReadMore read 0"),e.read(0),n===t.length)break}t.readingMore=!1}function x(e){var t=e._readableState;t.readableListening=e.listenerCount("readable")>0,t.resumeScheduled&&!t.paused?t.flowing=!0:e.listenerCount("data")>0&&e.resume()}function L(e){h("readable nexttick read 0"),e.read(0)}function N(e,t){h("resume",t.reading),t.reading||e.read(0),t.resumeScheduled=!1,e.emit("resume"),j(e),t.flowing&&!t.reading&&e.read(0)}function j(e){var t=e._readableState;for(h("flow",t.flowing);t.flowing&&null!==e.read(););}function q(e,t){return 0===t.length?null:(t.objectMode?n=t.buffer.shift():!e||e>=t.length?(n=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.first():t.buffer.concat(t.length),t.buffer.clear()):n=t.buffer.consume(e,t.decoder),n);var n}function U(e){var t=e._readableState;h("endReadable",t.endEmitted),t.endEmitted||(t.ended=!0,n.nextTick(B,t,e))}function B(e,t){if(h("endReadableNT",e.endEmitted,e.length),!e.endEmitted&&0===e.length&&(e.endEmitted=!0,t.readable=!1,t.emit("end"),e.autoDestroy)){var n=t._writableState;(!n||n.autoDestroy&&n.finished)&&t.destroy()}}function H(e,t){for(var n=0,i=e.length;n<i;n++)if(e[n]===t)return n;return-1}R.prototype.read=function(e){h("read",e),e=parseInt(e,10);var t=this._readableState,n=e;if(0!==e&&(t.emittedReadable=!1),0===e&&t.needReadable&&((0!==t.highWaterMark?t.length>=t.highWaterMark:t.length>0)||t.ended))return h("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?U(this):M(this),null;if(0===(e=O(e,t))&&t.ended)return 0===t.length&&U(this),null;var i,s=t.needReadable;return h("need readable",s),(0===t.length||t.length-e<t.highWaterMark)&&h("length less than watermark",s=!0),t.ended||t.reading?h("reading or ended",s=!1):s&&(h("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=O(n,t))),null===(i=e>0?q(e,t):null)?(t.needReadable=t.length<=t.highWaterMark,e=0):(t.length-=e,t.awaitDrain=0),0===t.length&&(t.ended||(t.needReadable=!0),n!==e&&t.ended&&U(this)),null!==i&&this.emit("data",i),i},R.prototype._read=function(e){v(this,new w("_read()"))},R.prototype.pipe=function(e,t){var i=this,s=this._readableState;switch(s.pipesCount){case 0:s.pipes=e;break;case 1:s.pipes=[s.pipes,e];break;default:s.pipes.push(e)}s.pipesCount+=1,h("pipe count=%d opts=%j",s.pipesCount,t);var a=(!t||!1!==t.end)&&e!==n.stdout&&e!==n.stderr?d:m;function o(t,n){h("onunpipe"),t===i&&n&&!1===n.hasUnpiped&&(n.hasUnpiped=!0,h("cleanup"),e.removeListener("close",f),e.removeListener("finish",p),e.removeListener("drain",l),e.removeListener("error",g),e.removeListener("unpipe",o),i.removeListener("end",d),i.removeListener("end",m),i.removeListener("data",c),u=!0,!s.awaitDrain||e._writableState&&!e._writableState.needDrain||l())}function d(){h("onend"),e.end()}s.endEmitted?n.nextTick(a):i.once("end",a),e.on("unpipe",o);var l=function(e){return function(){var t=e._readableState;h("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&r(e,"data")&&(t.flowing=!0,j(e))}}(i);e.on("drain",l);var u=!1;function c(t){h("ondata");var n=e.write(t);h("dest.write",n),!1===n&&((1===s.pipesCount&&s.pipes===e||s.pipesCount>1&&-1!==H(s.pipes,e))&&!u&&(h("false write response, pause",s.awaitDrain),s.awaitDrain++),i.pause())}function g(t){h("onerror",t),m(),e.removeListener("error",g),0===r(e,"error")&&v(e,t)}function f(){e.removeListener("finish",p),m()}function p(){h("onfinish"),e.removeListener("close",f),m()}function m(){h("unpipe"),i.unpipe(e)}return i.on("data",c),function(e,t,n){if("function"==typeof e.prependListener)return e.prependListener(t,n);e._events&&e._events[t]?Array.isArray(e._events[t])?e._events[t].unshift(n):e._events[t]=[n,e._events[t]]:e.on(t,n)}(e,"error",g),e.once("close",f),e.once("finish",p),e.emit("pipe",i),s.flowing||(h("pipe resume"),i.resume()),e},R.prototype.unpipe=function(e){var t=this._readableState,n={hasUnpiped:!1};if(0===t.pipesCount)return this;if(1===t.pipesCount)return e&&e!==t.pipes||(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this,n)),this;if(!e){var i=t.pipes,s=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var r=0;r<s;r++)i[r].emit("unpipe",this,{hasUnpiped:!1});return this}var a=H(t.pipes,e);return-1===a||(t.pipes.splice(a,1),t.pipesCount-=1,1===t.pipesCount&&(t.pipes=t.pipes[0]),e.emit("unpipe",this,n)),this},R.prototype.on=function(e,t){var i=a.prototype.on.call(this,e,t),s=this._readableState;return"data"===e?(s.readableListening=this.listenerCount("readable")>0,!1!==s.flowing&&this.resume()):"readable"===e&&(s.endEmitted||s.readableListening||(s.readableListening=s.needReadable=!0,s.flowing=!1,s.emittedReadable=!1,h("on readable",s.length,s.reading),s.length?M(this):s.reading||n.nextTick(L,this))),i},R.prototype.addListener=R.prototype.on,R.prototype.removeListener=function(e,t){var i=a.prototype.removeListener.call(this,e,t);return"readable"===e&&n.nextTick(x,this),i},R.prototype.removeAllListeners=function(e){var t=a.prototype.removeAllListeners.apply(this,arguments);return"readable"!==e&&void 0!==e||n.nextTick(x,this),t},R.prototype.resume=function(){var e=this._readableState;return e.flowing||(h("resume"),e.flowing=!e.readableListening,function(e,t){t.resumeScheduled||(t.resumeScheduled=!0,n.nextTick(N,e,t))}(this,e)),e.paused=!1,this},R.prototype.pause=function(){return h("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(h("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},R.prototype.wrap=function(e){var t=this,n=this._readableState,i=!1;for(var s in e.on("end",(function(){if(h("wrapped end"),n.decoder&&!n.ended){var e=n.decoder.end();e&&e.length&&t.push(e)}t.push(null)})),e.on("data",(function(s){(h("wrapped data"),n.decoder&&(s=n.decoder.write(s)),n.objectMode&&null==s)||(n.objectMode||s&&s.length)&&(t.push(s)||(i=!0,e.pause()))})),e)void 0===this[s]&&"function"==typeof e[s]&&(this[s]=function(t){return function(){return e[t].apply(e,arguments)}}(s));for(var r=0;r<E.length;r++)e.on(E[r],this.emit.bind(this,E[r]));return this._read=function(t){h("wrapped _read",t),i&&(i=!1,e.resume())},this},"function"==typeof Symbol&&(R.prototype[Symbol.asyncIterator]=function(){return void 0===c&&(c=e("./internal/streams/async_iterator")),c(this)}),Object.defineProperty(R.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(R.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(R.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(e){this._readableState&&(this._readableState.flowing=e)}}),R._fromList=q,Object.defineProperty(R.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),"function"==typeof Symbol&&(R.from=function(t,n){return void 0===g&&(g=e("./internal/streams/from")),g(R,t,n)})}).call(this)}).call(this,e("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":42,"./_stream_duplex":43,"./internal/streams/async_iterator":48,"./internal/streams/buffer_list":49,"./internal/streams/destroy":50,"./internal/streams/from":52,"./internal/streams/state":54,"./internal/streams/stream":55,_process:34,buffer:"buffer",events:"events",inherits:31,"string_decoder/":73,util:26}],46:[function(e,t,n){"use strict";t.exports=l;var i=e("../errors").codes,s=i.ERR_METHOD_NOT_IMPLEMENTED,r=i.ERR_MULTIPLE_CALLBACK,a=i.ERR_TRANSFORM_ALREADY_TRANSFORMING,o=i.ERR_TRANSFORM_WITH_LENGTH_0,d=e("./_stream_duplex");function h(e,t){var n=this._transformState;n.transforming=!1;var i=n.writecb;if(null===i)return this.emit("error",new r);n.writechunk=null,n.writecb=null,null!=t&&this.push(t),i(e);var s=this._readableState;s.reading=!1,(s.needReadable||s.length<s.highWaterMark)&&this._read(s.highWaterMark)}function l(e){if(!(this instanceof l))return new l(e);d.call(this,e),this._transformState={afterTransform:h.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.on("prefinish",u)}function u(){var e=this;"function"!=typeof this._flush||this._readableState.destroyed?c(this,null,null):this._flush((function(t,n){c(e,t,n)}))}function c(e,t,n){if(t)return e.emit("error",t);if(null!=n&&e.push(n),e._writableState.length)throw new o;if(e._transformState.transforming)throw new a;return e.push(null)}e("inherits")(l,d),l.prototype.push=function(e,t){return this._transformState.needTransform=!1,d.prototype.push.call(this,e,t)},l.prototype._transform=function(e,t,n){n(new s("_transform()"))},l.prototype._write=function(e,t,n){var i=this._transformState;if(i.writecb=n,i.writechunk=e,i.writeencoding=t,!i.transforming){var s=this._readableState;(i.needTransform||s.needReadable||s.length<s.highWaterMark)&&this._read(s.highWaterMark)}},l.prototype._read=function(e){var t=this._transformState;null===t.writechunk||t.transforming?t.needTransform=!0:(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform))},l.prototype._destroy=function(e,t){d.prototype._destroy.call(this,e,(function(e){t(e)}))}},{"../errors":42,"./_stream_duplex":43,inherits:31}],47:[function(e,t,n){(function(n,i){(function(){"use strict";function s(e){var t=this;this.next=null,this.entry=null,this.finish=function(){!function(e,t,n){var i=e.entry;e.entry=null;for(;i;){var s=i.callback;t.pendingcb--,s(n),i=i.next}t.corkedRequestsFree.next=e}(t,e)}}var r;t.exports=R,R.WritableState=T;var a={deprecate:e("util-deprecate")},o=e("./internal/streams/stream"),d=e("buffer").Buffer,h=i.Uint8Array||function(){};var l,u=e("./internal/streams/destroy"),c=e("./internal/streams/state").getHighWaterMark,g=e("../errors").codes,f=g.ERR_INVALID_ARG_TYPE,p=g.ERR_METHOD_NOT_IMPLEMENTED,m=g.ERR_MULTIPLE_CALLBACK,b=g.ERR_STREAM_CANNOT_PIPE,y=g.ERR_STREAM_DESTROYED,_=g.ERR_STREAM_NULL_VALUES,w=g.ERR_STREAM_WRITE_AFTER_END,S=g.ERR_UNKNOWN_ENCODING,v=u.errorOrDestroy;function E(){}function T(t,i,a){r=r||e("./_stream_duplex"),t=t||{},"boolean"!=typeof a&&(a=i instanceof r),this.objectMode=!!t.objectMode,a&&(this.objectMode=this.objectMode||!!t.writableObjectMode),this.highWaterMark=c(this,t,"writableHighWaterMark",a),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var o=!1===t.decodeStrings;this.decodeStrings=!o,this.defaultEncoding=t.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){!function(e,t){var i=e._writableState,s=i.sync,r=i.writecb;if("function"!=typeof r)throw new m;if(function(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}(i),t)!function(e,t,i,s,r){--t.pendingcb,i?(n.nextTick(r,s),n.nextTick(C,e,t),e._writableState.errorEmitted=!0,v(e,s)):(r(s),e._writableState.errorEmitted=!0,v(e,s),C(e,t))}(e,i,s,t,r);else{var a=O(i)||e.destroyed;a||i.corked||i.bufferProcessing||!i.bufferedRequest||k(e,i),s?n.nextTick(I,e,i,a,r):I(e,i,a,r)}}(i,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new s(this)}function R(t){var n=this instanceof(r=r||e("./_stream_duplex"));if(!n&&!l.call(R,this))return new R(t);this._writableState=new T(t,this,n),this.writable=!0,t&&("function"==typeof t.write&&(this._write=t.write),"function"==typeof t.writev&&(this._writev=t.writev),"function"==typeof t.destroy&&(this._destroy=t.destroy),"function"==typeof t.final&&(this._final=t.final)),o.call(this)}function P(e,t,n,i,s,r,a){t.writelen=i,t.writecb=a,t.writing=!0,t.sync=!0,t.destroyed?t.onwrite(new y("write")):n?e._writev(s,t.onwrite):e._write(s,r,t.onwrite),t.sync=!1}function I(e,t,n,i){n||function(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}(e,t),t.pendingcb--,i(),C(e,t)}function k(e,t){t.bufferProcessing=!0;var n=t.bufferedRequest;if(e._writev&&n&&n.next){var i=t.bufferedRequestCount,r=new Array(i),a=t.corkedRequestsFree;a.entry=n;for(var o=0,d=!0;n;)r[o]=n,n.isBuf||(d=!1),n=n.next,o+=1;r.allBuffers=d,P(e,t,!0,t.length,r,"",a.finish),t.pendingcb++,t.lastBufferedRequest=null,a.next?(t.corkedRequestsFree=a.next,a.next=null):t.corkedRequestsFree=new s(t),t.bufferedRequestCount=0}else{for(;n;){var h=n.chunk,l=n.encoding,u=n.callback;if(P(e,t,!1,t.objectMode?1:h.length,h,l,u),n=n.next,t.bufferedRequestCount--,t.writing)break}null===n&&(t.lastBufferedRequest=null)}t.bufferedRequest=n,t.bufferProcessing=!1}function O(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function M(e,t){e._final((function(n){t.pendingcb--,n&&v(e,n),t.prefinished=!0,e.emit("prefinish"),C(e,t)}))}function C(e,t){var i=O(t);if(i&&(function(e,t){t.prefinished||t.finalCalled||("function"!=typeof e._final||t.destroyed?(t.prefinished=!0,e.emit("prefinish")):(t.pendingcb++,t.finalCalled=!0,n.nextTick(M,e,t)))}(e,t),0===t.pendingcb&&(t.finished=!0,e.emit("finish"),t.autoDestroy))){var s=e._readableState;(!s||s.autoDestroy&&s.endEmitted)&&e.destroy()}return i}e("inherits")(R,o),T.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},function(){try{Object.defineProperty(T.prototype,"buffer",{get:a.deprecate((function(){return this.getBuffer()}),"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(e){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(l=Function.prototype[Symbol.hasInstance],Object.defineProperty(R,Symbol.hasInstance,{value:function(e){return!!l.call(this,e)||this===R&&(e&&e._writableState instanceof T)}})):l=function(e){return e instanceof this},R.prototype.pipe=function(){v(this,new b)},R.prototype.write=function(e,t,i){var s,r=this._writableState,a=!1,o=!r.objectMode&&(s=e,d.isBuffer(s)||s instanceof h);return o&&!d.isBuffer(e)&&(e=function(e){return d.from(e)}(e)),"function"==typeof t&&(i=t,t=null),o?t="buffer":t||(t=r.defaultEncoding),"function"!=typeof i&&(i=E),r.ending?function(e,t){var i=new w;v(e,i),n.nextTick(t,i)}(this,i):(o||function(e,t,i,s){var r;return null===i?r=new _:"string"==typeof i||t.objectMode||(r=new f("chunk",["string","Buffer"],i)),!r||(v(e,r),n.nextTick(s,r),!1)}(this,r,e,i))&&(r.pendingcb++,a=function(e,t,n,i,s,r){if(!n){var a=function(e,t,n){e.objectMode||!1===e.decodeStrings||"string"!=typeof t||(t=d.from(t,n));return t}(t,i,s);i!==a&&(n=!0,s="buffer",i=a)}var o=t.objectMode?1:i.length;t.length+=o;var h=t.length<t.highWaterMark;h||(t.needDrain=!0);if(t.writing||t.corked){var l=t.lastBufferedRequest;t.lastBufferedRequest={chunk:i,encoding:s,isBuf:n,callback:r,next:null},l?l.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else P(e,t,!1,o,i,s,r);return h}(this,r,o,e,t,i)),a},R.prototype.cork=function(){this._writableState.corked++},R.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.bufferProcessing||!e.bufferedRequest||k(this,e))},R.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new S(e);return this._writableState.defaultEncoding=e,this},Object.defineProperty(R.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(R.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),R.prototype._write=function(e,t,n){n(new p("_write()"))},R.prototype._writev=null,R.prototype.end=function(e,t,i){var s=this._writableState;return"function"==typeof e?(i=e,e=null,t=null):"function"==typeof t&&(i=t,t=null),null!=e&&this.write(e,t),s.corked&&(s.corked=1,this.uncork()),s.ending||function(e,t,i){t.ending=!0,C(e,t),i&&(t.finished?n.nextTick(i):e.once("finish",i));t.ended=!0,e.writable=!1}(this,s,i),this},Object.defineProperty(R.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(R.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(e){this._writableState&&(this._writableState.destroyed=e)}}),R.prototype.destroy=u.destroy,R.prototype._undestroy=u.undestroy,R.prototype._destroy=function(e,t){t(e)}}).call(this)}).call(this,e("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":42,"./_stream_duplex":43,"./internal/streams/destroy":50,"./internal/streams/state":54,"./internal/streams/stream":55,_process:34,buffer:"buffer",inherits:31,"util-deprecate":74}],48:[function(e,t,n){(function(n){(function(){"use strict";var i;function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var r=e("./end-of-stream"),a=Symbol("lastResolve"),o=Symbol("lastReject"),d=Symbol("error"),h=Symbol("ended"),l=Symbol("lastPromise"),u=Symbol("handlePromise"),c=Symbol("stream");function g(e,t){return{value:e,done:t}}function f(e){var t=e[a];if(null!==t){var n=e[c].read();null!==n&&(e[l]=null,e[a]=null,e[o]=null,t(g(n,!1)))}}function p(e){n.nextTick(f,e)}var m=Object.getPrototypeOf((function(){})),b=Object.setPrototypeOf((s(i={get stream(){return this[c]},next:function(){var e=this,t=this[d];if(null!==t)return Promise.reject(t);if(this[h])return Promise.resolve(g(void 0,!0));if(this[c].destroyed)return new Promise((function(t,i){n.nextTick((function(){e[d]?i(e[d]):t(g(void 0,!0))}))}));var i,s=this[l];if(s)i=new Promise(function(e,t){return function(n,i){e.then((function(){t[h]?n(g(void 0,!0)):t[u](n,i)}),i)}}(s,this));else{var r=this[c].read();if(null!==r)return Promise.resolve(g(r,!1));i=new Promise(this[u])}return this[l]=i,i}},Symbol.asyncIterator,(function(){return this})),s(i,"return",(function(){var e=this;return new Promise((function(t,n){e[c].destroy(null,(function(e){e?n(e):t(g(void 0,!0))}))}))})),i),m);t.exports=function(e){var t,n=Object.create(b,(s(t={},c,{value:e,writable:!0}),s(t,a,{value:null,writable:!0}),s(t,o,{value:null,writable:!0}),s(t,d,{value:null,writable:!0}),s(t,h,{value:e._readableState.endEmitted,writable:!0}),s(t,u,{value:function(e,t){var i=n[c].read();i?(n[l]=null,n[a]=null,n[o]=null,e(g(i,!1))):(n[a]=e,n[o]=t)},writable:!0}),t));return n[l]=null,r(e,(function(e){if(e&&"ERR_STREAM_PREMATURE_CLOSE"!==e.code){var t=n[o];return null!==t&&(n[l]=null,n[a]=null,n[o]=null,t(e)),void(n[d]=e)}var i=n[a];null!==i&&(n[l]=null,n[a]=null,n[o]=null,i(g(void 0,!0))),n[h]=!0})),e.on("readable",p.bind(null,n)),n}}).call(this)}).call(this,e("_process"))},{"./end-of-stream":51,_process:34}],49:[function(e,t,n){"use strict";function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var a=e("buffer").Buffer,o=e("util").inspect,d=o&&o.custom||"inspect";t.exports=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.head=null,this.tail=null,this.length=0}var t,n,h;return t=e,n=[{key:"push",value:function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length}},{key:"unshift",value:function(e){var t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length}},{key:"shift",value:function(){if(0!==this.length){var e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(e){if(0===this.length)return"";for(var t=this.head,n=""+t.data;t=t.next;)n+=e+t.data;return n}},{key:"concat",value:function(e){if(0===this.length)return a.alloc(0);for(var t,n,i,s=a.allocUnsafe(e>>>0),r=this.head,o=0;r;)t=r.data,n=s,i=o,a.prototype.copy.call(t,n,i),o+=r.data.length,r=r.next;return s}},{key:"consume",value:function(e,t){var n;return e<this.head.data.length?(n=this.head.data.slice(0,e),this.head.data=this.head.data.slice(e)):n=e===this.head.data.length?this.shift():t?this._getString(e):this._getBuffer(e),n}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(e){var t=this.head,n=1,i=t.data;for(e-=i.length;t=t.next;){var s=t.data,r=e>s.length?s.length:e;if(r===s.length?i+=s:i+=s.slice(0,e),0==(e-=r)){r===s.length?(++n,t.next?this.head=t.next:this.head=this.tail=null):(this.head=t,t.data=s.slice(r));break}++n}return this.length-=n,i}},{key:"_getBuffer",value:function(e){var t=a.allocUnsafe(e),n=this.head,i=1;for(n.data.copy(t),e-=n.data.length;n=n.next;){var s=n.data,r=e>s.length?s.length:e;if(s.copy(t,t.length-e,0,r),0==(e-=r)){r===s.length?(++i,n.next?this.head=n.next:this.head=this.tail=null):(this.head=n,n.data=s.slice(r));break}++i}return this.length-=i,t}},{key:d,value:function(e,t){return o(this,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},t,{depth:0,customInspect:!1}))}}],n&&r(t.prototype,n),h&&r(t,h),e}()},{buffer:"buffer",util:26}],50:[function(e,t,n){(function(e){(function(){"use strict";function n(e,t){s(e,t),i(e)}function i(e){e._writableState&&!e._writableState.emitClose||e._readableState&&!e._readableState.emitClose||e.emit("close")}function s(e,t){e.emit("error",t)}t.exports={destroy:function(t,r){var a=this,o=this._readableState&&this._readableState.destroyed,d=this._writableState&&this._writableState.destroyed;return o||d?(r?r(t):t&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,e.nextTick(s,this,t)):e.nextTick(s,this,t)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(t||null,(function(t){!r&&t?a._writableState?a._writableState.errorEmitted?e.nextTick(i,a):(a._writableState.errorEmitted=!0,e.nextTick(n,a,t)):e.nextTick(n,a,t):r?(e.nextTick(i,a),r(t)):e.nextTick(i,a)})),this)},undestroy:function(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)},errorOrDestroy:function(e,t){var n=e._readableState,i=e._writableState;n&&n.autoDestroy||i&&i.autoDestroy?e.destroy(t):e.emit("error",t)}}}).call(this)}).call(this,e("_process"))},{_process:34}],51:[function(e,t,n){"use strict";var i=e("../../../errors").codes.ERR_STREAM_PREMATURE_CLOSE;function s(){}t.exports=function e(t,n,r){if("function"==typeof n)return e(t,null,n);n||(n={}),r=function(e){var t=!1;return function(){if(!t){t=!0;for(var n=arguments.length,i=new Array(n),s=0;s<n;s++)i[s]=arguments[s];e.apply(this,i)}}}(r||s);var a=n.readable||!1!==n.readable&&t.readable,o=n.writable||!1!==n.writable&&t.writable,d=function(){t.writable||l()},h=t._writableState&&t._writableState.finished,l=function(){o=!1,h=!0,a||r.call(t)},u=t._readableState&&t._readableState.endEmitted,c=function(){a=!1,u=!0,o||r.call(t)},g=function(e){r.call(t,e)},f=function(){var e;return a&&!u?(t._readableState&&t._readableState.ended||(e=new i),r.call(t,e)):o&&!h?(t._writableState&&t._writableState.ended||(e=new i),r.call(t,e)):void 0},p=function(){t.req.on("finish",l)};return!function(e){return e.setHeader&&"function"==typeof e.abort}(t)?o&&!t._writableState&&(t.on("end",d),t.on("close",d)):(t.on("complete",l),t.on("abort",f),t.req?p():t.on("request",p)),t.on("end",c),t.on("finish",l),!1!==n.error&&t.on("error",g),t.on("close",f),function(){t.removeListener("complete",l),t.removeListener("abort",f),t.removeListener("request",p),t.req&&t.req.removeListener("finish",l),t.removeListener("end",d),t.removeListener("close",d),t.removeListener("finish",l),t.removeListener("end",c),t.removeListener("error",g),t.removeListener("close",f)}}},{"../../../errors":42}],52:[function(e,t,n){t.exports=function(){throw new Error("Readable.from is not available in the browser")}},{}],53:[function(e,t,n){"use strict";var i;var s=e("../../../errors").codes,r=s.ERR_MISSING_ARGS,a=s.ERR_STREAM_DESTROYED;function o(e){if(e)throw e}function d(t,n,s,r){r=function(e){var t=!1;return function(){t||(t=!0,e.apply(void 0,arguments))}}(r);var o=!1;t.on("close",(function(){o=!0})),void 0===i&&(i=e("./end-of-stream")),i(t,{readable:n,writable:s},(function(e){if(e)return r(e);o=!0,r()}));var d=!1;return function(e){if(!o&&!d)return d=!0,function(e){return e.setHeader&&"function"==typeof e.abort}(t)?t.abort():"function"==typeof t.destroy?t.destroy():void r(e||new a("pipe"))}}function h(e){e()}function l(e,t){return e.pipe(t)}function u(e){return e.length?"function"!=typeof e[e.length-1]?o:e.pop():o}t.exports=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i,s=u(t);if(Array.isArray(t[0])&&(t=t[0]),t.length<2)throw new r("streams");var a=t.map((function(e,n){var r=n<t.length-1;return d(e,r,n>0,(function(e){i||(i=e),e&&a.forEach(h),r||(a.forEach(h),s(i))}))}));return t.reduce(l)}},{"../../../errors":42,"./end-of-stream":51}],54:[function(e,t,n){"use strict";var i=e("../../../errors").codes.ERR_INVALID_OPT_VALUE;t.exports={getHighWaterMark:function(e,t,n,s){var r=function(e,t,n){return null!=e.highWaterMark?e.highWaterMark:t?e[n]:null}(t,s,n);if(null!=r){if(!isFinite(r)||Math.floor(r)!==r||r<0)throw new i(s?n:"highWaterMark",r);return Math.floor(r)}return e.objectMode?16:16384}}},{"../../../errors":42}],55:[function(e,t,n){t.exports=e("events").EventEmitter},{events:"events"}],56:[function(e,t,n){(n=t.exports=e("./lib/_stream_readable.js")).Stream=n,n.Readable=n,n.Writable=e("./lib/_stream_writable.js"),n.Duplex=e("./lib/_stream_duplex.js"),n.Transform=e("./lib/_stream_transform.js"),n.PassThrough=e("./lib/_stream_passthrough.js"),n.finished=e("./lib/internal/streams/end-of-stream.js"),n.pipeline=e("./lib/internal/streams/pipeline.js")},{"./lib/_stream_duplex.js":43,"./lib/_stream_passthrough.js":44,"./lib/_stream_readable.js":45,"./lib/_stream_transform.js":46,"./lib/_stream_writable.js":47,"./lib/internal/streams/end-of-stream.js":51,"./lib/internal/streams/pipeline.js":53}],57:[function(e,t,n){(function(n){(function(){
/*! simple-websocket. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
const i=e("debug")("simple-websocket"),s=e("randombytes"),r=e("readable-stream"),a=e("queue-microtask"),o=e("ws"),d="function"!=typeof o?WebSocket:o;class h extends r.Duplex{constructor(e={}){if("string"==typeof e&&(e={url:e}),super(e=Object.assign({allowHalfOpen:!1},e)),null==e.url&&null==e.socket)throw new Error("Missing required `url` or `socket` option");if(null!=e.url&&null!=e.socket)throw new Error("Must specify either `url` or `socket` option, not both");if(this._id=s(4).toString("hex").slice(0,7),this._debug("new websocket: %o",e),this.connected=!1,this.destroyed=!1,this._chunk=null,this._cb=null,this._interval=null,e.socket)this.url=e.socket.url,this._ws=e.socket,this.connected=e.socket.readyState===d.OPEN;else{this.url=e.url;try{this._ws="function"==typeof o?new d(e.url,null,{...e,encoding:void 0}):new d(e.url)}catch(e){return void a((()=>this.destroy(e)))}}this._ws.binaryType="arraybuffer",e.socket&&this.connected?a((()=>this._handleOpen())):this._ws.onopen=()=>this._handleOpen(),this._ws.onmessage=e=>this._handleMessage(e),this._ws.onclose=()=>this._handleClose(),this._ws.onerror=e=>this._handleError(e),this._handleFinishBound=()=>this._handleFinish(),this.once("finish",this._handleFinishBound)}send(e){this._ws.send(e)}destroy(e){this._destroy(e,(()=>{}))}_destroy(e,t){if(!this.destroyed){if(this._debug("destroy (error: %s)",e&&(e.message||e)),this.readable=this.writable=!1,this._readableState.ended||this.push(null),this._writableState.finished||this.end(),this.connected=!1,this.destroyed=!0,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._handleFinishBound&&this.removeListener("finish",this._handleFinishBound),this._handleFinishBound=null,this._ws){const t=this._ws,n=()=>{t.onclose=null};if(t.readyState===d.CLOSED)n();else try{t.onclose=n,t.close()}catch(e){n()}t.onopen=null,t.onmessage=null,t.onerror=()=>{}}this._ws=null,e&&this.emit("error",e),this.emit("close"),t()}}_read(){}_write(e,t,n){if(this.destroyed)return n(new Error("cannot write after socket is destroyed"));if(this.connected){try{this.send(e)}catch(e){return this.destroy(e)}"function"!=typeof o&&this._ws.bufferedAmount>65536?(this._debug("start backpressure: bufferedAmount %d",this._ws.bufferedAmount),this._cb=n):n(null)}else this._debug("write before connect"),this._chunk=e,this._cb=n}_handleOpen(){if(!this.connected&&!this.destroyed){if(this.connected=!0,this._chunk){try{this.send(this._chunk)}catch(e){return this.destroy(e)}this._chunk=null,this._debug('sent chunk from "write before connect"');const e=this._cb;this._cb=null,e(null)}"function"!=typeof o&&(this._interval=setInterval((()=>this._onInterval()),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")}}_handleMessage(e){if(this.destroyed)return;let t=e.data;t instanceof ArrayBuffer&&(t=n.from(t)),this.push(t)}_handleClose(){this.destroyed||(this._debug("on close"),this.destroy())}_handleError(e){this.destroy(new Error(`Error connecting to ${this.url}`))}_handleFinish(){if(this.destroyed)return;const e=()=>{setTimeout((()=>this.destroy()),1e3)};this.connected?e():this.once("connect",e)}_onInterval(){if(!this._cb||!this._ws||this._ws.bufferedAmount>65536)return;this._debug("ending backpressure: bufferedAmount %d",this._ws.bufferedAmount);const e=this._cb;this._cb=null,e(null)}_debug(){const e=[].slice.call(arguments);e[0]="["+this._id+"] "+e[0],i.apply(null,e)}}h.WEBSOCKET_SUPPORT=!!d,t.exports=h}).call(this)}).call(this,e("buffer").Buffer)},{buffer:"buffer",debug:"debug","queue-microtask":35,randombytes:36,"readable-stream":72,ws:26}],58:[function(e,t,n){arguments[4][42][0].apply(n,arguments)},{dup:42}],59:[function(e,t,n){arguments[4][43][0].apply(n,arguments)},{"./_stream_readable":61,"./_stream_writable":63,_process:34,dup:43,inherits:31}],60:[function(e,t,n){arguments[4][44][0].apply(n,arguments)},{"./_stream_transform":62,dup:44,inherits:31}],61:[function(e,t,n){arguments[4][45][0].apply(n,arguments)},{"../errors":58,"./_stream_duplex":59,"./internal/streams/async_iterator":64,"./internal/streams/buffer_list":65,"./internal/streams/destroy":66,"./internal/streams/from":68,"./internal/streams/state":70,"./internal/streams/stream":71,_process:34,buffer:"buffer",dup:45,events:"events",inherits:31,"string_decoder/":73,util:26}],62:[function(e,t,n){arguments[4][46][0].apply(n,arguments)},{"../errors":58,"./_stream_duplex":59,dup:46,inherits:31}],63:[function(e,t,n){arguments[4][47][0].apply(n,arguments)},{"../errors":58,"./_stream_duplex":59,"./internal/streams/destroy":66,"./internal/streams/state":70,"./internal/streams/stream":71,_process:34,buffer:"buffer",dup:47,inherits:31,"util-deprecate":74}],64:[function(e,t,n){arguments[4][48][0].apply(n,arguments)},{"./end-of-stream":67,_process:34,dup:48}],65:[function(e,t,n){arguments[4][49][0].apply(n,arguments)},{buffer:"buffer",dup:49,util:26}],66:[function(e,t,n){arguments[4][50][0].apply(n,arguments)},{_process:34,dup:50}],67:[function(e,t,n){arguments[4][51][0].apply(n,arguments)},{"../../../errors":58,dup:51}],68:[function(e,t,n){arguments[4][52][0].apply(n,arguments)},{dup:52}],69:[function(e,t,n){arguments[4][53][0].apply(n,arguments)},{"../../../errors":58,"./end-of-stream":67,dup:53}],70:[function(e,t,n){arguments[4][54][0].apply(n,arguments)},{"../../../errors":58,dup:54}],71:[function(e,t,n){arguments[4][55][0].apply(n,arguments)},{dup:55,events:"events"}],72:[function(e,t,n){arguments[4][56][0].apply(n,arguments)},{"./lib/_stream_duplex.js":59,"./lib/_stream_passthrough.js":60,"./lib/_stream_readable.js":61,"./lib/_stream_transform.js":62,"./lib/_stream_writable.js":63,"./lib/internal/streams/end-of-stream.js":67,"./lib/internal/streams/pipeline.js":69,dup:56}],73:[function(e,t,n){"use strict";var i=e("safe-buffer").Buffer,s=i.isEncoding||function(e){switch((e=""+e)&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function r(e){var t;switch(this.encoding=function(e){var t=function(e){if(!e)return"utf8";for(var t;;)switch(e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:if(t)return;e=(""+e).toLowerCase(),t=!0}}(e);if("string"!=typeof t&&(i.isEncoding===s||!s(e)))throw new Error("Unknown encoding: "+e);return t||e}(e),this.encoding){case"utf16le":this.text=d,this.end=h,t=4;break;case"utf8":this.fillLast=o,t=4;break;case"base64":this.text=l,this.end=u,t=3;break;default:return this.write=c,void(this.end=g)}this.lastNeed=0,this.lastTotal=0,this.lastChar=i.allocUnsafe(t)}function a(e){return e<=127?0:e>>5==6?2:e>>4==14?3:e>>3==30?4:e>>6==2?-1:-2}function o(e){var t=this.lastTotal-this.lastNeed,n=function(e,t,n){if(128!=(192&t[0]))return e.lastNeed=0,"";if(e.lastNeed>1&&t.length>1){if(128!=(192&t[1]))return e.lastNeed=1,"";if(e.lastNeed>2&&t.length>2&&128!=(192&t[2]))return e.lastNeed=2,""}}(this,e);return void 0!==n?n:this.lastNeed<=e.length?(e.copy(this.lastChar,t,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(e.copy(this.lastChar,t,0,e.length),void(this.lastNeed-=e.length))}function d(e,t){if((e.length-t)%2==0){var n=e.toString("utf16le",t);if(n){var i=n.charCodeAt(n.length-1);if(i>=55296&&i<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1],n.slice(0,-1)}return n}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=e[e.length-1],e.toString("utf16le",t,e.length-1)}function h(e){var t=e&&e.length?this.write(e):"";if(this.lastNeed){var n=this.lastTotal-this.lastNeed;return t+this.lastChar.toString("utf16le",0,n)}return t}function l(e,t){var n=(e.length-t)%3;return 0===n?e.toString("base64",t):(this.lastNeed=3-n,this.lastTotal=3,1===n?this.lastChar[0]=e[e.length-1]:(this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1]),e.toString("base64",t,e.length-n))}function u(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+this.lastChar.toString("base64",0,3-this.lastNeed):t}function c(e){return e.toString(this.encoding)}function g(e){return e&&e.length?this.write(e):""}n.StringDecoder=r,r.prototype.write=function(e){if(0===e.length)return"";var t,n;if(this.lastNeed){if(void 0===(t=this.fillLast(e)))return"";n=this.lastNeed,this.lastNeed=0}else n=0;return n<e.length?t?t+this.text(e,n):this.text(e,n):t||""},r.prototype.end=function(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+"":t},r.prototype.text=function(e,t){var n=function(e,t,n){var i=t.length-1;if(i<n)return 0;var s=a(t[i]);if(s>=0)return s>0&&(e.lastNeed=s-1),s;if(--i<n||-2===s)return 0;if((s=a(t[i]))>=0)return s>0&&(e.lastNeed=s-2),s;if(--i<n||-2===s)return 0;if((s=a(t[i]))>=0)return s>0&&(2===s?s=0:e.lastNeed=s-3),s;return 0}(this,e,t);if(!this.lastNeed)return e.toString("utf8",t);this.lastTotal=n;var i=e.length-(n-this.lastNeed);return e.copy(this.lastChar,0,i),e.toString("utf8",t,i)},r.prototype.fillLast=function(e){if(this.lastNeed<=e.length)return e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,e.length),this.lastNeed-=e.length}},{"safe-buffer":38}],74:[function(e,t,n){(function(e){(function(){function n(t){try{if(!e.localStorage)return!1}catch(e){return!1}var n=e.localStorage[t];return null!=n&&"true"===String(n).toLowerCase()}t.exports=function(e,t){if(n("noDeprecation"))return e;var i=!1;return function(){if(!i){if(n("throwDeprecation"))throw new Error(t);n("traceDeprecation")?console.trace(t):console.warn(t),i=!0}return e.apply(this,arguments)}}}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],75:[function(e,t,n){t.exports=function e(t,n){if(t&&n)return e(t)(n);if("function"!=typeof t)throw new TypeError("need wrapper function");return Object.keys(t).forEach((function(e){i[e]=t[e]})),i;function i(){for(var e=new Array(arguments.length),n=0;n<e.length;n++)e[n]=arguments[n];var i=t.apply(this,e),s=e[e.length-1];return"function"==typeof i&&i!==s&&Object.keys(s).forEach((function(e){i[e]=s[e]})),i}}},{}],"p2p-media-loader-hlsjs":[function(e,t,n){"use strict";
/**
 * @license Apache-2.0
 * Copyright 2018 Novage LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var s=Object.getOwnPropertyDescriptor(t,n);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,s)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),s=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||i(t,e,n)},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.initJwPlayer=n.initMediaElementJsPlayer=n.initVideoJsHlsJsPlugin=n.initVideoJsContribHlsJsPlayer=n.initFlowplayerHlsJsPlayer=n.initClapprPlayer=n.initHlsJsPlayer=n.version=void 0,n.version="0.6.2",s(e("./engine"),n),s(e("./segment-manager"),n);const a=(0,r(e("debug")).default)("p2pml:hlsjs-init");function o(e){e&&e.config&&e.config.loader&&"function"==typeof e.config.loader.getEngine&&d(e,e.config.loader.getEngine())}function d(e,t){e.on("hlsFragChanged",((e,n)=>{a("HLS Frag changed.",n);const i=n.frag,s=2!==i.byteRange.length?void 0:{offset:i.byteRange[0],length:i.byteRange[1]-i.byteRange[0]};t.setPlayingSegment(i.url,s,i.start,i.duration)})),e.on("hlsDestroying",(async()=>{await t.destroy()})),e.on("hlsError",((n,i)=>{if("bufferStalledError"===i.details){const n=void 0===e.media?e.el_:e.media;n&&t.setPlayingSegmentByCurrentTime(n.currentTime)}})),e.on("seeking",(()=>{a("Player seeking."),t.abortCurrentRequest()}))}n.initHlsJsPlayer=o,n.initClapprPlayer=function(e){e.on("play",(()=>{const t=e.core.getCurrentPlayback();t._hls&&!t._hls._p2pm_linitialized&&(t._hls._p2pm_linitialized=!0,o(e.core.getCurrentPlayback()._hls))}))},n.initFlowplayerHlsJsPlayer=function(e){e.on("ready",(()=>{var t;return o(null!==(t=e.engine.hlsjs)&&void 0!==t?t:e.engine.hls)}))},n.initVideoJsContribHlsJsPlayer=function(e){e.ready((()=>{const t=e.tech_.options_;t&&t.hlsjsConfig&&t.hlsjsConfig.loader&&"function"==typeof t.hlsjsConfig.loader.getEngine&&d(e.tech_,t.hlsjsConfig.loader.getEngine())}))},n.initVideoJsHlsJsPlugin=function(){null!=videojs&&null!=videojs.Html5Hlsjs&&videojs.Html5Hlsjs.addHook("beforeinitialize",((e,t)=>{t.config&&t.config.loader&&"function"==typeof t.config.loader.getEngine&&d(t,t.config.loader.getEngine())}))},n.initMediaElementJsPlayer=function(e){e.addEventListener("hlsFragChanged",(t=>{const n=e.hlsPlayer;if(n&&n.config&&n.config.loader&&"function"==typeof n.config.loader.getEngine){const e=n.config.loader.getEngine();if(t.data&&t.data.length>1){const n=t.data[1].frag,i=2!==n.byteRange.length?void 0:{offset:n.byteRange[0],length:n.byteRange[1]-n.byteRange[0]};e.setPlayingSegment(n.url,i,n.start,n.duration)}}})),e.addEventListener("hlsDestroying",(async()=>{const t=e.hlsPlayer;if(t&&t.config&&t.config.loader&&"function"==typeof t.config.loader.getEngine){const e=t.config.loader.getEngine();await e.destroy()}})),e.addEventListener("hlsError",(t=>{const n=e.hlsPlayer;if(n&&n.config&&n.config.loader&&"function"==typeof n.config.loader.getEngine&&void 0!==t.data&&"bufferStalledError"===t.data.details){n.config.loader.getEngine().setPlayingSegmentByCurrentTime(n.media.currentTime)}}))},n.initJwPlayer=function(e,t){const n=setInterval((()=>{e.hls&&e.hls.config&&(clearInterval(n),Object.assign(e.hls.config,t),o(e.hls))}),200)}},{"./engine":3,"./segment-manager":5,debug:"debug"}]},{},[1]);
